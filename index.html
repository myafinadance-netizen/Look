<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–± ‚Äî –í–µ–±</title>
  <meta name="description" content="–ì–∞—Ä–¥–µ—Ä–æ–± ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞, –ø–ª–∞–Ω—à–µ—Ç–∞ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞" />
  <style>
    /* --- Theme variables --- */
    :root{
      --bg-0:#06101a; --bg-1:#0b1220; --panel:#0f1720; --muted:#9CA3AF;
      --accent:#dc2626; --accent-2:#06b6d4; --card-border:rgba(255,255,255,0.04);
      --glass:rgba(255,255,255,0.02); --radius:12px; --gap:16px; --max-width:1200px;
      --safe-top:env(safe-area-inset-top,0px);
    }

    /* --- Base --- */
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));color:#e6eef6;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max-width);margin:calc(20px + var(--safe-top)) auto 40px;padding:16px}
    header{display:flex;align-items:flex-start;gap:16px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}

    /* --- Tabs --- */
    .tabs{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer;font-size:14px}
    .tab.active{background:rgba(255,255,255,0.03);color:#fff;border-color:var(--card-border)}

    /* --- Layout --- */
    .main-grid{display:grid;grid-template-columns:1fr 320px;gap:var(--gap);align-items:start}
    .panel{background:var(--panel);border-radius:var(--radius);padding:16px;border:1px solid var(--card-border);box-shadow:0 6px 24px rgba(0,0,0,0.35)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}

    /* --- Form --- */
    .form-row{display:flex;gap:12px;align-items:center}
    input[type="text"], textarea, select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.35);color:#fff;font-size:14px}
    textarea{min-height:60px;resize:vertical}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* --- Items list --- */
    .items-list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
    .item{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .item-photo{width:72px;height:72px;background:#061214;border-radius:8px;flex-shrink:0;object-fit:cover}
    .item .title{font-weight:700}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px}
    .badge.green{background:#064e3b;color:#bbf7d0}
    .badge.red{background:#7f1d1d;color:#ffd7d7}
    .muted{color:var(--muted);font-size:13px}

    /* --- Sidebar analytics --- */
    .sidebar .stat-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent-2),#06b6d4)}

    /* --- Utilities --- */
    .flex{display:flex;gap:8px;align-items:center}
    .ml-auto{margin-left:auto}
    .small{font-size:13px;color:var(--muted)}
    .kpi{font-size:20px;font-weight:700}

    /* --- Responsive: tablet / mobile --- */
    @media (max-width:1000px){ :root{--max-width:1000px} .main-grid{grid-template-columns:1fr 300px} }
    @media (max-width:900px){
      .wrap{padding:12px;margin:12px auto 40px}
      header{flex-direction:row;align-items:center;gap:10px}
      h1{font-size:18px}
      .tabs{flex-wrap:wrap}
      .main-grid{grid-template-columns:1fr;gap:12px}
      .sidebar{order:2}
      .mobile-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
      .mobile-toolbar .btn{padding:8px 10px}
    }
    @media (max-width:480px){
      :root{--max-width:740px;--gap:12px}
      header{padding-top:var(--safe-top);padding-bottom:6px}
      h1{font-size:16px}
      .tab{padding:8px 10px;font-size:13px}
      .item-photo{width:56px;height:56px}
      .btn.primary{padding:10px 12px}
      .card{padding:10px}
      .form-row{flex-direction:column;align-items:stretch}
      .form-row>*{width:100%}
      .kpi{font-size:18px}
    }

    /* Focus ring */
    :focus{outline:2px solid rgba(6,182,212,0.18);outline-offset:2px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div style="flex:1">
        <h1>–ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–± ‚Äî Web</h1>
        <div class="subtitle">–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã + –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. –ú–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ GitHub Pages.</div>
        <div class="tabs" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
          <button class="tab active" data-tab="wardrobe">–ì–∞—Ä–¥–µ—Ä–æ–±</button>
          <button class="tab" data-tab="shopping">–®–æ–ø–∏–Ω–≥</button>
          <button class="tab" data-tab="outfits">–û–±—Ä–∞–∑—ã</button>
          <button class="tab" data-tab="inspiration">–ò–¥–µ–∏</button>
          <button class="tab" data-tab="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        </div>
      </div>

      <div class="mobile-toolbar ml-auto" id="mobileToolbar" style="display:none">
        <button class="btn ghost" id="toggleSidebarBtn" aria-expanded="true">‚ò∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="btn ghost" id="toggleAnalyticsBtn">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>
    </header>

    <main class="main-grid" id="mainGrid">
      <!-- Left column contains multiple sections; we show/hide by tab -->
      <section>
        <!-- Wardrobe section -->
        <div id="wardrobeSection" class="panel">
          <div class="flex" style="gap:12px;align-items:center;margin-bottom:12px">
            <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–≥–∞–º" style="flex:1" />
            <select id="filterStatus" class="small">
              <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="owned">–¢–æ–ª—å–∫–æ –µ—Å—Ç—å</option>
              <option value="needed">–¢–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ</option>
            </select>
            <select id="filterPriority" class="small">
              <option value="all">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
              <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
              <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
              <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
            </select>
            <div class="ml-auto flex">
              <button id="openAnalytics" class="btn ghost">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
              <button id="exportBtn" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px">
            <h3 style="margin:0 0 8px 0">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å <span class="small muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ –î–æ–±–∞–≤–∏—Ç—å</span></h3>
            <div style="display:grid;grid-template-columns:1fr 160px 120px;gap:10px;">
              <input id="newName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä: –ö–æ—Å—Ç—é–º —á–µ—Ä–Ω—ã–π)" />
              <select id="newCategory">
                <option value="suits">–ö–æ—Å—Ç—é–º—ã</option>
                <option value="shirts">–†—É–±–∞—à–∫–∏</option>
                <option value="knitwear">–¢—Ä–∏–∫–æ—Ç–∞–∂</option>
                <option value="polo">–ü–æ–ª–æ</option>
                <option value="pants">–ë—Ä—é–∫–∏</option>
                <option value="shoes">–û–±—É–≤—å</option>
                <option value="accessories">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
              </select>
              <select id="newStatus">
                <option value="–µ—Å—Ç—å">–ï—Å—Ç—å</option>
                <option value="–Ω—É–∂–µ–Ω">–ù—É–∂–µ–Ω</option>
              </select>

              <input id="newTags" type="text" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="grid-column:1/span2" />
              <select id="newPriority" style="width:120px">
                <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
              </select>

              <textarea id="newNotes" placeholder="–ó–∞–º–µ—Ç–∫–∏" style="grid-column:1/span3"></textarea>
              <div style="grid-column:1/span2">
                <input id="newPhoto" type="file" accept="image/*" />
              </div>
              <div style="display:flex;align-items:center;justify-content:flex-end">
                <button id="addItemBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>

          <div id="itemsList" class="items-list"></div>
        </div>

        <!-- Shopping section -->
        <div id="shoppingSection" class="panel" style="display:none">
          <div class="card">
            <h3 style="margin-top:0">–®–æ–ø–∏–Ω–≥ ‚Äî –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</h3>
            <div style="display:grid;grid-template-columns:1fr 160px 120px;gap:8px;align-items:center">
              <input id="shopName" type="text" placeholder="–ß—Ç–æ –∫—É–ø–∏—Ç—å (–ø—Ä–∏–º–µ—Ä: –¢—É—Ñ–ª–∏ —á–µ—Ä–Ω—ã–µ)" />
              <select id="shopPriority">
                <option>–ö–†–ò–¢–ò–ß–ù–û</option>
                <option>–í–´–°–û–ö–ò–ô</option>
                <option selected>–°–†–ï–î–ù–ò–ô</option>
                <option>–ù–ò–ó–ö–ò–ô</option>
              </select>
              <input id="shopPrice" type="text" placeholder="–¶–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: ‚Ç¨200-300)" />
              <div style="grid-column:1 / span 3; display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <button id="addShopBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å –≤ —à–æ–ø–∏–Ω–≥</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏</h3>
            <div id="activePurchases" style="margin-top:8px"></div>
            <h3 style="margin-top:12px">–ö—É–ø–ª–µ–Ω–æ</h3>
            <div id="completedPurchases" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Outfits section -->
        <div id="outfitsSection" class="panel" style="display:none">
          <div class="card">
            <h3 style="margin-top:0">–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑</h3>
            <div style="display:grid;grid-template-columns:1fr 160px;gap:8px">
              <input id="outfitName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞" />
              <select id="outfitSeason">
                <option value="">–°–µ–∑–æ–Ω</option>
                <option value="–ª–µ—Ç–æ">–õ–µ—Ç–æ</option>
                <option value="–∑–∏–º–∞">–ó–∏–º–∞</option>
                <option value="–≤–µ—Å–Ω–∞">–í–µ—Å–Ω–∞</option>
                <option value="–æ—Å–µ–Ω—å">–û—Å–µ–Ω—å</option>
                <option value="–≤—Å–µ—Å–µ–∑–æ–Ω">–í—Å–µ—Å–µ–∑–æ–Ω</option>
              </select>
              <input id="outfitCategory" type="text" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–†–∞–±–æ—Ç–∞, –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)" />
              <div></div>
              <input id="outfitItems" type="text" placeholder="–í–µ—â–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–ø—Ä–∏–º–µ—Ä: –†—É–±–∞—à–∫–∞ –±–µ–ª–∞—è, –ö–æ—Å—Ç—é–º —á–µ—Ä–Ω—ã–π)" style="grid-column:1/span2" />
              <div style="display:flex;justify-content:flex-end">
                <button id="addOutfitBtn" class="btn primary">–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <h3>–°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤</h3>
            <div id="outfitsList" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Inspiration section -->
        <div id="inspirationSection" class="panel" style="display:none">
          <div class="card">
            <h3 style="margin-top:0">–ò–¥–µ–∏ / –°—Å—ã–ª–∫–∏</h3>
            <div style="display:flex;gap:8px">
              <input id="newLink" type="url" placeholder="https://..." style="flex:1" />
              <button id="addLinkBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>
          <div style="margin-top:12px">
            <div id="linksList"></div>
          </div>
        </div>

        <!-- Analytics section (expanded) -->
        <div id="analyticsSection" class="panel" style="display:none">
          <h3 style="margin-top:0">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</h3>
          <div id="analyticsContent"></div>
        </div>
      </section>

      <!-- Sidebar (always visible) -->
      <aside class="sidebar panel" id="sidebar">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div class="small muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div class="kpi" id="statTotal">‚Äî</div>
          </div>
          <div style="text-align:right">
            <div class="small muted">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
            <div class="kpi" id="statCompletion">‚Äî</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small muted">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
          <div id="categoryStats" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏</div>
          <div id="topTags" style="margin-top:8px"></div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    /* -------------------------------
       Logic: storage, rendering, tabs
       ------------------------------- */

    const STORAGE_KEYS = {
      wardrobe: 'wardrobe-data-v2',
      shopping: 'shopping-data-v2',
      outfits: 'outfits-data-v2',
      links: 'inspiration-data-v2',
      analytics: 'wardrobe-analytics-v1'
    };

    function safeParse(s){ try { return JSON.parse(s); } catch(e) { return null; } }
    function storageGet(key){ try { const raw = localStorage.getItem(key); return raw ? safeParse(raw) : null; } catch(e){ console.warn('storageGet', e); return null; } }
    function storageSet(key, data){ try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) { console.warn('storageSet', e); } }

    async function trackEvent(type, payload = {}) {
      try {
        const ev = { id: Date.now() + Math.floor(Math.random()*1000), type, payload, ts: new Date().toISOString() };
        const arr = storageGet(STORAGE_KEYS.analytics) || [];
        arr.push(ev);
        storageSet(STORAGE_KEYS.analytics, arr);
        if(window.ANALYTICS_ENDPOINT){
          fetch(window.ANALYTICS_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(ev) }).catch(()=>{});
        }
      } catch(e){ console.warn('trackEvent', e); }
    }

    function initDefaults(){
      const w = storageGet(STORAGE_KEYS.wardrobe);
      if(!w){
        const initial = {
          suits: [{id:1,name:'–ö–æ—Å—Ç—é–º —á–µ—Ä–Ω—ã–π –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π',status:'–µ—Å—Ç—å',priority:'–≤—ã—Å–æ–∫–∏–π',tags:'–æ—Ñ–∏—Å',notes:''}],
          shirts: [{id:2,name:'–†—É–±–∞—à–∫–∞ –±–µ–ª–∞—è',status:'–µ—Å—Ç—å',priority:'–Ω–∏–∑–∫–∏–π',tags:'–±–∞–∑–æ–≤—ã–π',notes:''}],
          knitwear: [], polo: [], pants: [], shoes: [], accessories: []
        };
        storageSet(STORAGE_KEYS.wardrobe, initial);
      }
      if(!storageGet(STORAGE_KEYS.shopping)) storageSet(STORAGE_KEYS.shopping, []);
      if(!storageGet(STORAGE_KEYS.outfits)) storageSet(STORAGE_KEYS.outfits, []);
      if(!storageGet(STORAGE_KEYS.links)) storageSet(STORAGE_KEYS.links, []);
      if(!storageGet(STORAGE_KEYS.analytics)) storageSet(STORAGE_KEYS.analytics, []);
    }
    initDefaults();

    let wardrobe = storageGet(STORAGE_KEYS.wardrobe) || {};
    function saveWardrobe(){ storageSet(STORAGE_KEYS.wardrobe, wardrobe); }

    function uid(){ return Date.now() + Math.floor(Math.random()*1000); }
    function flatten(w){ return Object.entries(w).flatMap(([cat,items]) => (items||[]).map(i => ({...i, category:cat}))); }

    /* ----- Tabs handling ----- */
    const tabs = document.querySelectorAll('.tab');
    function showTab(name){
      // hide all sections first
      ['wardrobe','shopping','outfits','inspiration','analytics'].forEach(id => {
        const el = document.getElementById(id + 'Section');
        if(el) el.style.display = (id === name) ? 'block' : 'none';
      });
      // update active class
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
      // if special render needed
      if(name === 'shopping') renderShopping();
      if(name === 'outfits') renderOutfits();
      if(name === 'inspiration') renderLinks();
      if(name === 'analytics') renderAnalyticsView();
      // ensure items re-render for wardrobe
      if(name === 'wardrobe') renderItems();
    }
    tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));

    /* ----- Wardrobe rendering (existing) ----- */
    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    function renderItems(){
      const container = document.getElementById('itemsList');
      container.innerHTML = '';
      const items = flatten(wardrobe);
      const search = (document.getElementById('search').value||'').toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
      const prFilter = document.getElementById('filterPriority').value;

      let shown = items.slice();
      if(search) shown = shown.filter(i => i.name.toLowerCase().includes(search) || (i.tags||'').toLowerCase().includes(search));
      if(statusFilter==='owned') shown = shown.filter(i => i.status === '–µ—Å—Ç—å');
      if(statusFilter==='needed') shown = shown.filter(i => i.status !== '–µ—Å—Ç—å');
      if(prFilter !== 'all') shown = shown.filter(i => i.priority === prFilter);

      if(shown.length === 0){
        container.innerHTML = '<div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</div>';
        return;
      }
      shown.forEach(it => {
        const el = document.createElement('div'); el.className = 'item';
        const photo = it.photo ? `<img src="${it.photo}" alt="" class="item-photo"/>` : `<div class="item-photo" aria-hidden="true"></div>`;
        const priorityColor = it.priority==='–∫—Ä–∏—Ç–∏—á–Ω—ã–π' ? '#7f1d1d' : it.priority==='–≤—ã—Å–æ–∫–∏–π' ? '#9a3412' : it.priority==='—Å—Ä–µ–¥–Ω–∏–π' ? '#713f12' : '#374151';
        el.innerHTML = `
          ${photo}
          <div style="flex:1">
            <div class="title">${escapeHtml(it.name)} <span class="muted">(${escapeHtml(it.category)})</span></div>
            <div style="margin-top:6px">
              <span class="badge ${it.status==='–µ—Å—Ç—å'?'green':'red'}">${it.status==='–µ—Å—Ç—å'?'–ï—Å—Ç—å':'–ù—É–∂–Ω–æ'}</span>
              <span class="badge" style="background:${priorityColor};color:#fff;margin-left:8px">${escapeHtml(it.priority)}</span>
            </div>
            <div style="margin-top:8px" class="muted">${it.tags ? '#' + escapeHtml(it.tags.split(',')[0]) : ''}</div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn ghost" onclick="editItem(${it.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              <button class="btn ghost" onclick="deleteItem(${it.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
        container.appendChild(el);
      });
    }

    function renderSidebar(){
      const items = flatten(wardrobe);
      const total = items.length;
      const owned = items.filter(i=>i.status==='–µ—Å—Ç—å').length;
      const completion = total ? Math.round((owned/total)*100) : 0;
      document.getElementById('statTotal').textContent = `${total} –≤–µ—â–µ–π`;
      document.getElementById('statCompletion').textContent = `${completion}%`;

      // category stats
      const cats = Object.entries(wardrobe).map(([cat,arr])=>{
        const total = (arr||[]).length;
        const owned = (arr||[]).filter(i=>i.status==='–µ—Å—Ç—å').length;
        const percent = total? Math.round((owned/total)*100):0;
        return {cat,total,owned,percent};
      });
      const catCont = document.getElementById('categoryStats'); catCont.innerHTML = '';
      cats.forEach(c => {
        const r = document.createElement('div'); r.style.marginBottom='10px';
        r.innerHTML = `<div style="display:flex;justify-content:space-between"><div class="small">${escapeHtml(c.cat)}</div><div class="small">${c.owned}/${c.total}</div></div>
                       <div class="progress" style="margin-top:6px"><i style="width:${c.percent}%"></i></div>`;
        catCont.appendChild(r);
      });

      // top tags
      const tags = getTopTags(10);
      const tagsCont = document.getElementById('topTags'); tagsCont.innerHTML = '';
      if(tags.length===0) tagsCont.innerHTML = '<div class="muted">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>';
      tags.forEach(t => {
        const el = document.createElement('div'); el.className='small muted'; el.textContent = `#${t.tag} ‚Äî ${t.count}`;
        tagsCont.appendChild(el);
      });
    }

    /* ----- Shopping rendering and actions ----- */
    function renderShopping(){
      const s = storageGet(STORAGE_KEYS.shopping) || [];
      const active = s.filter(i=>!i.purchased);
      const completed = s.filter(i=>i.purchased);
      const actCont = document.getElementById('activePurchases'); actCont.innerHTML = '';
      active.forEach(i=>{
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div style="flex:1"><div><strong>${escapeHtml(i.item)}</strong> <span class="muted small">${escapeHtml(i.priority)} ${i.price? '‚Äî ' + escapeHtml(i.price): ''}</span></div></div>`;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
        const tog = document.createElement('button'); tog.className='btn ghost small'; tog.textContent='–ö—É–ø–ª–µ–Ω–æ'; tog.onclick = ()=> togglePurchased(i.id);
        const rem = document.createElement('button'); rem.className='btn ghost small'; rem.textContent='–£–¥–∞–ª–∏—Ç—å'; rem.onclick = ()=> removeShopping(i.id);
        actions.appendChild(tog); actions.appendChild(rem);
        div.appendChild(actions);
        actCont.appendChild(div);
      });
      const compCont = document.getElementById('completedPurchases'); compCont.innerHTML = '';
      completed.forEach(i=>{
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div style="flex:1"><div><strong style="text-decoration:line-through">${escapeHtml(i.item)}</strong> <span class="muted small">${i.purchasedDate||''}</span></div></div>`;
        const rem = document.createElement('button'); rem.className='btn ghost small'; rem.textContent='–£–¥–∞–ª–∏—Ç—å'; rem.onclick = ()=> removeShopping(i.id);
        div.appendChild(rem);
        compCont.appendChild(div);
      });
    }

    document.getElementById('addShopBtn').addEventListener('click', async ()=>{
      const item = (document.getElementById('shopName').value||'').trim(); if(!item) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏');
      const priority = document.getElementById('shopPriority').value; const price = document.getElementById('shopPrice').value;
      const list = storageGet(STORAGE_KEYS.shopping) || [];
      const obj = { id: uid(), item, priority, price, category:'', plannedDate:'', purchased:false };
      list.push(obj);
      storageSet(STORAGE_KEYS.shopping, list);
      trackEvent('add_shopping', { item, priority, price });
      document.getElementById('shopName').value=''; document.getElementById('shopPrice').value='';
      renderShopping();
    });

    function removeShopping(id){
      let list = storageGet(STORAGE_KEYS.shopping) || [];
      list = list.filter(i=>i.id!==id);
      storageSet(STORAGE_KEYS.shopping, list);
      trackEvent('remove_shopping', { id });
      renderShopping();
    }

    function togglePurchased(id){
      let list = storageGet(STORAGE_KEYS.shopping) || [];
      list = list.map(i => i.id===id ? { ...i, purchased: !i.purchased, purchasedDate: !i.purchased? (new Date()).toISOString().split('T')[0] : null } : i);
      storageSet(STORAGE_KEYS.shopping, list);
      trackEvent('toggle_purchased', { id });
      renderShopping();
    }

    /* ----- Outfits rendering and actions ----- */
    function renderOutfits(){
      const list = storageGet(STORAGE_KEYS.outfits) || [];
      const outCont = document.getElementById('outfitsList'); outCont.innerHTML = '';
      const w = storageGet(STORAGE_KEYS.wardrobe) || wardrobe;
      const all = flatten(w);
      if(list.length === 0){ outCont.innerHTML = '<div class="muted">–ù–µ—Ç –æ–±—Ä–∞–∑–æ–≤</div>'; return; }
      list.forEach(o => {
        const check = o.items.map(item => ({ item, have: all.some(wi=>wi.name.toLowerCase().includes(item.toLowerCase()) && wi.status==='–µ—Å—Ç—å') }));
        const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(o.name)}</strong> <span class="muted small">${escapeHtml(o.category||'')}</span></div><div><button class="btn ghost small">–£–¥–∞–ª–∏—Ç—å</button></div></div>`;
        const listEl = document.createElement('div'); listEl.style.marginTop='8px';
        check.forEach(c => {
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between';
          row.innerHTML = `<div class="small">${escapeHtml(c.item)}</div><div class="small ${c.have? '':'muted'}">${c.have? '–ï—Å—Ç—å':'–ù—É–∂–Ω–æ'}</div>`;
          listEl.appendChild(row);
        });
        div.appendChild(listEl);
        const delBtn = div.querySelector('button'); delBtn.onclick = ()=> { if(confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑?')) { deleteOutfit(o.id); } };
        outCont.appendChild(div);
      });
    }

    document.getElementById('addOutfitBtn').addEventListener('click', async ()=>{
      const name = (document.getElementById('outfitName').value||'').trim(); if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞');
      const category = document.getElementById('outfitCategory').value; const season = document.getElementById('outfitSeason').value;
      const items = (document.getElementById('outfitItems').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const list = storageGet(STORAGE_KEYS.outfits) || [];
      const o = { id: uid(), name, category, season, items, created: new Date().toISOString() };
      list.push(o); storageSet(STORAGE_KEYS.outfits, list);
      trackEvent('add_outfit', { name, items });
      document.getElementById('outfitName').value=''; document.getElementById('outfitItems').value='';
      renderOutfits();
    });

    function deleteOutfit(id){
      let list = storageGet(STORAGE_KEYS.outfits) || [];
      list = list.filter(o=>o.id!==id);
      storageSet(STORAGE_KEYS.outfits, list);
      trackEvent('delete_outfit', { id });
      renderOutfits();
    }

    /* ----- Links (inspiration) ----- */
    function renderLinks(){
      const links = storageGet(STORAGE_KEYS.links) || [];
      const cont = document.getElementById('linksList'); cont.innerHTML = '';
      if(links.length === 0) { cont.innerHTML = '<div class="muted">–°—Å—ã–ª–æ–∫ –Ω–µ—Ç</div>'; return; }
      links.forEach(l => {
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `<div style="flex:1"><a href="${escapeHtml(l.url)}" target="_blank" rel="noopener noreferrer" class="small">${escapeHtml(l.url)}</a></div>`;
        const del = document.createElement('button'); del.className='btn ghost small'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.onclick = ()=> removeLink(l.id);
        div.appendChild(del);
        cont.appendChild(div);
      });
    }
    document.getElementById('addLinkBtn').addEventListener('click', async ()=>{
      const url = (document.getElementById('newLink').value||'').trim(); if(!url) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
      const list = storageGet(STORAGE_KEYS.links) || [];
      list.push({ id: uid(), url }); storageSet(STORAGE_KEYS.links, list);
      trackEvent('add_link', { url });
      document.getElementById('newLink').value=''; renderLinks();
    });
    function removeLink(id){
      let list = storageGet(STORAGE_KEYS.links) || [];
      list = list.filter(l=>l.id!==id); storageSet(STORAGE_KEYS.links, list); trackEvent('remove_link', { id }); renderLinks();
    }

    /* ----- Analytics view (expanded) ----- */
    async function renderAnalyticsView(){
      const items = flatten(storageGet(STORAGE_KEYS.wardrobe) || wardrobe);
      const s = {
        total: items.length,
        owned: items.filter(i=>i.status==='–µ—Å—Ç—å').length,
        needed: items.filter(i=>i.status!=='–µ—Å—Ç—å').length,
        critical: items.filter(i => (i.priority||'').toString().toLowerCase().includes('–∫—Ä–∏—Ç')).length,
      };
      const events = storageGet(STORAGE_KEYS.analytics) || [];
      const container = document.getElementById('analyticsContent');
      container.innerHTML = `
        <div class="card">
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <div style="min-width:140px"><div class="small muted">–í—Å–µ–≥–æ –≤–µ—â–µ–π</div><div class="kpi">${s.total}</div></div>
            <div style="min-width:140px"><div class="small muted">–ï—Å—Ç—å</div><div class="kpi">${s.owned}</div></div>
            <div style="min-width:140px"><div class="small muted">–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å</div><div class="kpi">${s.needed}</div></div>
            <div style="min-width:140px"><div class="small muted">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div><div class="kpi">${s.critical}</div></div>
            <div style="min-width:140px"><div class="small muted">–°–æ–±—ã—Ç–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div><div class="kpi">${events.length}</div></div>
          </div>
        </div>
        <div style="margin-top:12px" class="card">
          <h4>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏</h4>
          <div id="aTags"></div>
        </div>
      `;
      const tags = getTopTags(20);
      const tcont = document.getElementById('aTags'); tcont.innerHTML = '';
      if(tags.length===0) tcont.innerHTML = '<div class="muted">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>';
      tags.forEach(t => { const el = document.createElement('div'); el.className='small muted'; el.textContent = `#${t.tag} ‚Äî ${t.count}`; tcont.appendChild(el); });
    }

    /* ----- Helper functions reused in UI ----- */
    function getTopTags(topN=10){
      const all = flatten(wardrobe);
      const map = {};
      all.forEach(i => {
        (i.tags||'').split(',').map(t => t.trim().toLowerCase()).filter(Boolean).forEach(t => map[t] = (map[t]||0)+1);
      });
      return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,topN).map(([tag,count]) => ({ tag, count }));
    }

    function getPriorityStats(){
      const all = flatten(wardrobe);
      const map = {};
      all.forEach(i => { const p = (i.priority||'–Ω–∏–∑–∫–∏–π').toString(); map[p] = (map[p]||0)+1; });
      return Object.entries(map).map(([priority,count]) => ({ priority, count }));
    }

    /* ----- CRUD actions (wardrobe) ----- */
    async function addItem(){
      const name = (document.getElementById('newName').value||'').trim();
      if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—â–∏'); return; }
      const category = document.getElementById('newCategory').value;
      const status = document.getElementById('newStatus').value;
      const priority = document.getElementById('newPriority').value;
      const tags = (document.getElementById('newTags').value||'').trim();
      const notes = (document.getElementById('newNotes').value||'').trim();

      const fileInput = document.getElementById('newPhoto');
      let photo = '';
      if(fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        photo = await new Promise(resolve => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.readAsDataURL(f);
        });
      }

      const item = { id: uid(), name, status, priority, tags, notes, photo };
      wardrobe[category] = wardrobe[category] || [];
      wardrobe[category].push(item);
      saveWardrobe();
      trackEvent('add_item', { category, name, priority, status });
      clearAddForm();
      renderAll();
    }

    function clearAddForm(){
      document.getElementById('newName').value=''; document.getElementById('newTags').value=''; document.getElementById('newNotes').value=''; document.getElementById('newPhoto').value='';
    }

    function deleteItem(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤–µ—â—å?')) return;
      Object.keys(wardrobe).forEach(cat => {
        wardrobe[cat] = (wardrobe[cat]||[]).filter(i => i.id !== id);
      });
      saveWardrobe();
      trackEvent('delete_item', { id });
      renderAll();
    }

    function editItem(id){
      let item = null; let catKey = null;
      for(const [cat,arr] of Object.entries(wardrobe)){
        const found = (arr||[]).find(i => i.id === id);
        if(found){ item = found; catKey = cat; break; }
      }
      if(!item) return alert('–í–µ—â—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      const newName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', item.name);
      if(newName === null) return;
      const newStatus = prompt('–°—Ç–∞—Ç—É—Å (–µ—Å—Ç—å/–Ω—É–∂–µ–Ω)', item.status) || item.status;
      const newPriority = prompt('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π/–∫—Ä–∏—Ç–∏—á–Ω—ã–π)', item.priority) || item.priority;
      const newTags = prompt('–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)', item.tags||'') ;
      const newNotes = prompt('–ó–∞–º–µ—Ç–∫–∏', item.notes||'') ;
      Object.assign(item, { name: newName, status: newStatus, priority: newPriority, tags: newTags, notes: newNotes });
      saveWardrobe();
      trackEvent('update_item', { id, after: { name:newName, status:newStatus, priority:newPriority } });
      renderAll();
    }

    /* ----- Utilities / event bindings ----- */
    document.getElementById('addItemBtn').addEventListener('click', addItem);
    document.getElementById('search').addEventListener('input', () => renderItems());
    document.getElementById('filterStatus').addEventListener('change', ()=> renderItems());
    document.getElementById('filterPriority').addEventListener('change', ()=> renderItems());
    document.getElementById('exportBtn').addEventListener('click', async ()=> { await exportFullReport(); });
    document.getElementById('openAnalytics').addEventListener('click', ()=> { showTab('analytics'); trackEvent('open_analytics', {}); });

    function updateMobileToolbar(){
      const mt = document.getElementById('mobileToolbar');
      if(window.innerWidth <= 900) mt.style.display = 'flex'; else mt.style.display = 'none';
    }
    window.addEventListener('resize', updateMobileToolbar);

    /* ----- Render all ----- */
    function renderAll(){
      wardrobe = storageGet(STORAGE_KEYS.wardrobe) || wardrobe;
      renderItems();
      renderSidebar();
    }

    // Expose for inline buttons
    window.deleteItem = deleteItem;
    window.editItem = editItem;

    // initial render
    renderAll();
    updateMobileToolbar();
    trackEvent('page_view', { path: location.pathname });

    // Show default tab (wardrobe)
    showTab('wardrobe');
  </script>
</body>
</html>
