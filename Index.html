import React, { useState, useEffect } from 'react';
import { Plus, Search, Package, ShoppingBag, Star, Lightbulb, Trash2, Edit2, Save, TrendingUp, Download, Tag, X, Check, Calendar, Grid, List, Camera, Image } from 'lucide-react';

const ANALYTICS_KEY = 'wardrobe-analytics-v1';

const WardrobeApp = () => {
  const [activeTab, setActiveTab] = useState('wardrobe');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [wardrobeItems, setWardrobeItems] = useState({});
  const [shoppingList, setShoppingList] = useState([]);
  const [outfits, setOutfits] = useState([]);
  const [inspirationLinks, setInspirationLinks] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [editingItem, setEditingItem] = useState(null);
  const [newItem, setNewItem] = useState({ name: '', category: 'suits', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '', notes: '', photo: '' });
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterPriority, setFilterPriority] = useState('all');
  const [showStats, setShowStats] = useState(true);
  const [outfitFilter, setOutfitFilter] = useState('all');
  const [newShop, setNewShop] = useState({ item: '', priority: '–°–†–ï–î–ù–ò–ô', price: '', category: '', plannedDate: '' });
  const [newOutfit, setNewOutfit] = useState({ name: '', category: '', season: '', items: '' });
  const [newLink, setNewLink] = useState('');
  const [viewMode, setViewMode] = useState('list'); // 'list' –∏–ª–∏ 'grid'
  const [uploadingPhoto, setUploadingPhoto] = useState(null);

  // Analytics UI toggle
  const [showAnalytics, setShowAnalytics] = useState(false);
  const [analyticsEvents, setAnalyticsEvents] = useState([]);

  // ---- Analytics helpers ----
  const trackEvent = async (type, payload = {}) => {
    try {
      const event = { id: Date.now(), type, payload, ts: new Date().toISOString() };
      const existing = JSON.parse(localStorage.getItem(ANALYTICS_KEY) || '[]');
      existing.push(event);
      localStorage.setItem(ANALYTICS_KEY, JSON.stringify(existing));
      setAnalyticsEvents(existing.slice(-200));
      if (window.ANALYTICS_ENDPOINT) {
        fetch(window.ANALYTICS_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(event),
        }).catch(() => {});
      }
    } catch (e) {
      console.error('Analytics error', e);
    }
  };

  const loadAnalyticsFromStorage = () => {
    try {
      const existing = JSON.parse(localStorage.getItem(ANALYTICS_KEY) || '[]');
      setAnalyticsEvents(existing.slice(-200));
    } catch (e) {
      setAnalyticsEvents([]);
    }
  };

  // ---- Data loading ----
  useEffect(() => {
    loadData();
    loadAnalyticsFromStorage();
  }, []);

  const loadData = async () => {
    try {
      const wardrobeResult = await window.storage.get('wardrobe-data-v2');
      const shoppingResult = await window.storage.get('shopping-data-v2');
      const outfitsResult = await window.storage.get('outfits-data-v2');
      const linksResult = await window.storage.get('inspiration-data-v2');

      if (wardrobeResult) {
        setWardrobeItems(JSON.parse(wardrobeResult.value));
      } else {
        const initial = loadInitialWardrobe();
        setWardrobeItems(initial);
        await window.storage.set('wardrobe-data-v2', JSON.stringify(initial));
      }

      if (shoppingResult) {
        setShoppingList(JSON.parse(shoppingResult.value));
      } else {
        const initial = loadInitialShopping();
        setShoppingList(initial);
        await window.storage.set('shopping-data-v2', JSON.stringify(initial));
      }

      if (outfitsResult) {
        setOutfits(JSON.parse(outfitsResult.value));
      } else {
        const initial = loadInitialOutfits();
        setOutfits(initial);
        await window.storage.set('outfits-data-v2', JSON.stringify(initial));
      }

      if (linksResult) {
        setInspirationLinks(JSON.parse(linksResult.value));
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      setWardrobeItems(loadInitialWardrobe());
      setShoppingList(loadInitialShopping());
      setOutfits(loadInitialOutfits());
    } finally {
      setIsLoading(false);
    }
  };

  const loadInitialWardrobe = () => ({
    suits: [
      { id: 1, name: '–ö–æ—Å—Ç—é–º —á–µ—Ä–Ω—ã–π –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π', status: '–µ—Å—Ç—å', priority: '–≤—ã—Å–æ–∫–∏–π', tags: '–æ—Ñ–∏—Å, —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π', notes: '' },
      { id: 2, name: '–ö–æ—Å—Ç—é–º —Å–∏–Ω–∏–π –≤ –ø–æ–ª–æ—Å–∫—É', status: '–µ—Å—Ç—å', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 3, name: '–ö–æ—Å—Ç—é–º –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫—ç–∂—É–∞–ª', status: '–µ—Å—Ç—å', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: 'casual', notes: '' },
      { id: 4, name: '–ö–æ—Å—Ç—é–º —Ç–µ–º–Ω—ã–π –≤ –∫–ª–µ—Ç–∫—É', status: '–µ—Å—Ç—å', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 5, name: '–ö–æ—Å—Ç—é–º —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π', status: '–Ω—É–∂–µ–Ω', priority: '–∫—Ä–∏—Ç–∏—á–Ω—ã–π', tags: '—Å—É–¥–µ–π—Å—Ç–≤–æ', notes: '' }
    ],
    shirts: [
      { id: 6, name: '–†—É–±–∞—à–∫–∏ –±–µ–ª—ã–µ', count: 2, status: '–µ—Å—Ç—å', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–±–∞–∑–æ–≤—ã–π', notes: '' },
      { id: 7, name: '–†—É–±–∞—à–∫–∏ —Å–∏–Ω–∏–µ', count: 3, status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–±–∞–∑–æ–≤—ã–π', notes: '' },
      { id: 8, name: '–†—É–±–∞—à–∫–∏ —á–µ—Ä–Ω—ã–µ', count: 2, status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–±–∞–∑–æ–≤—ã–π', notes: '' },
      { id: 9, name: '–†—É–±–∞—à–∫–∞ –±–µ–∂–µ–≤–∞—è', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 10, name: '–†—É–±–∞—à–∫–∞ —Ç–µ–º–Ω–æ-—Å–µ—Ä–∞—è —Å —É–∑–æ—Ä–æ–º', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 11, name: '–†—É–±–∞—à–∫–∏ —Å–µ—Ä—ã–µ –ª–µ—Ç–Ω–∏–µ', count: 2, status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' }
    ],
    knitwear: [
      { id: 12, name: '–í–æ–¥–æ–ª–∞–∑–∫–∞ –±–µ–ª–∞—è', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–∑–∏–º–∞, –±–∞–∑–æ–≤—ã–π', notes: '' },
      { id: 13, name: '–í–æ–¥–æ–ª–∞–∑–∫–∞ —Å–∏–Ω—è—è (–Ω–æ–≤–∞—è)', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–∑–∏–º–∞', notes: '' },
      { id: 14, name: '–í–æ–¥–æ–ª–∞–∑–∫–∞ —á–µ—Ä–Ω–∞—è', status: '–Ω—É–∂–Ω–∞', priority: '–≤—ã—Å–æ–∫–∏–π', tags: '–∑–∏–º–∞', notes: '' },
      { id: 15, name: '–ñ–∏–ªÔøΩÔøΩ—Ç–∫–∞ —Å–∏–Ω—è—è —à–µ—Ä—Å—Ç—å 100%', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', notes: '' },
      { id: 16, name: '–°–≤–∏—Ç–µ—Ä —Å–µ—Ä—ã–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 17, name: '–°–≤–∏—Ç–µ—Ä –≥–æ–ª—É–±–æ–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 18, name: '–°–≤–∏—Ç–µ—Ä —Å–∏–Ω–∏–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 19, name: '–°–≤–∏—Ç–µ—Ä –±–µ–ª—ã–π –≤ –ø–æ–ª–æ—Å–∫—É', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 20, name: '–°–≤–∏—Ç–µ—Ä –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π –≤ –ø–æ–ª–æ—Å–∫—É', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 21, name: '–°–≤–∏—Ç–µ—Ä —á–µ—Ä–Ω–æ-–±–µ–ª—ã–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 22, name: '–¢–æ–ª—Å—Ç–æ–≤–∫–∞ –±–æ—Ä–¥–æ–≤–∞—è', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—Å–ø–æ—Ä—Ç', notes: '' },
      { id: 23, name: '–¢–æ–ª—Å—Ç–æ–≤–∫–∞ —á–µ—Ä–Ω–∞—è', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—Å–ø–æ—Ä—Ç', notes: '' }
    ],
    polo: [
      { id: 24, name: '–ü–æ–ª–æ –±–æ—Ä–¥–æ–≤–æ–µ Ralph Lauren', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', signature: true, tags: '–ª–µ—Ç–æ', notes: '' },
      { id: 25, name: '–ü–æ–ª–æ —Å–∏–Ω–µ–µ Ralph Lauren', count: 2, status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' },
      { id: 26, name: '–ü–æ–ª–æ –∫–æ—Ä–∏—á–Ω–µ–≤–æ–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' },
      { id: 27, name: '–ü–æ–ª–æ —Å–µ—Ä–æ–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' },
      { id: 28, name: '–ü–æ–ª–æ —á–µ—Ä–Ω–æ–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' },
      { id: 29, name: '–ü–æ–ª–æ —Ç–µ–º–Ω–æ-—Å–∏–Ω–µ–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' }
    ],
    pants: [
      { id: 30, name: '–ë—Ä—é–∫–∏ —Å–µ—Ä—ã–µ —à–µ—Ä—Å—Ç—è–Ω—ã–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 31, name: '–ë—Ä—é–∫–∏ —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 32, name: '–ë—Ä—é–∫–∏ —Å–µ—Ä—ã–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 33, name: '–ë—Ä—é–∫–∏ —á–µ—Ä–Ω—ã–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–æ—Ñ–∏—Å', notes: '' },
      { id: 34, name: '–î–∂–∏–Ω—Å—ã —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 35, name: '–î–∂–∏–Ω—Å—ã —Å–µ—Ä—ã–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 36, name: '–î–∂–∏–Ω—Å—ã —Å–≤–µ—Ç–ª–æ-—Å–∏–Ω–∏–µ', count: 2, status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: 'casual', notes: '' },
      { id: 37, name: '–ß–∏–Ω–æ—Å—ã —Ç–∞–±–∞—á–Ω—ã–µ', status: '–Ω—É–∂–Ω—ã', priority: '–≤—ã—Å–æ–∫–∏–π', tags: 'casual', notes: '' },
      { id: 38, name: '–ß–∏–Ω–æ—Å—ã –æ–ª–∏–≤–∫–æ–≤—ã–µ', status: '–Ω—É–∂–Ω—ã', priority: '–≤—ã—Å–æ–∫–∏–π', tags: 'casual', notes: '' },
      { id: 39, name: '–ß–∏–Ω–æ—Å—ã –±–µ–∂–µ–≤—ã–µ', status: '–Ω—É–∂–Ω—ã', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: 'casual', notes: '' }
    ],
    shoes: [
      { id: 40, name: '–ß–µ–ª—Å–∏ —á–µ—Ä–Ω—ã–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ', notes: '' },
      { id: 41, name: '–ë–æ—Ç–∏–Ω–∫–∏ —á–µ—Ä–Ω—ã–µ –≤—ã—Å–æ–∫–∏–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–∑–∏–º–∞', notes: '' },
      { id: 42, name: '–ë–æ—Ç–∏–Ω–∫–∏ —É—Ç–µ–ø–ª–µ–Ω–Ω—ã–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–∑–∏–º–∞', notes: '' },
      { id: 43, name: '–ú–æ–∫–∞—Å–∏–Ω—ã —Å–µ—Ä—ã–µ', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '–ª–µ—Ç–æ', notes: '' },
      { id: 44, name: '–ö—Ä–æ—Å—Å–æ–≤–∫–∏ —á–µ—Ä–Ω—ã–µ', count: 3, status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—Å–ø–æ—Ä—Ç', notes: '' },
      { id: 45, name: '–¢—É—Ñ–ª–∏ —á–µ—Ä–Ω—ã–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ', status: '–Ω—É–∂–Ω—ã', priority: '–∫—Ä–∏—Ç–∏—á–Ω—ã–π', tags: '—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π', notes: '' },
      { id: 46, name: '–¢—É—Ñ–ª–∏ burgundy', status: '–Ω—É–∂–Ω—ã', priority: '–∫—Ä–∏—Ç–∏—á–Ω—ã–π', signature: true, tags: '–∏–∑—é–º–∏–Ω–∫–∞', notes: '' },
      { id: 47, name: '–ö—Ä–æ—Å—Å–æ–≤–∫–∏ –±–µ–ª—ã–µ', status: '–Ω—É–∂–Ω—ã', priority: '–≤—ã—Å–æ–∫–∏–π', tags: 'casual', notes: '' }
    ],
    accessories: [
      { id: 48, name: '–ì–∞–ª—Å—Ç—É–∫ —á–µ—Ä–Ω—ã–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π', notes: '' },
      { id: 49, name: '–ì–∞–ª—Å—Ç—É–∫ –±–æ—Ä–¥–æ–≤—ã–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', signature: true, tags: '–∏–∑—é–º–∏–Ω–∫–∞', notes: '' },
      { id: 50, name: '–ì–∞–ª—Å—Ç—É–∫ —Å–∏–Ω–∏–π', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π', notes: '' },
      { id: 51, name: '–ù–∞–≥—Ä—É–¥–Ω—ã–µ –ø–ª–∞—Ç–∫–∏', status: '–Ω—É–∂–Ω—ã', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã', notes: '' },
      { id: 52, name: '–ó–∞–ø–æ–Ω–∫–∏', status: '–Ω—É–∂–Ω—ã', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã', notes: '' },
      { id: 53, name: '–®–∞—Ä—Ñ –∫–∞—à–µ–º–∏—Ä', status: '–Ω—É–∂–µ–Ω', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–∑–∏–º–∞', notes: '' },
      { id: 54, name: '–ü–µ—Ä—á–∞—Ç–∫–∏ –∫–æ–∂–∞–Ω—ã–µ', status: '–Ω—É–∂–Ω—ã', priority: '—Å—Ä–µ–¥–Ω–∏–π', tags: '–∑–∏–º–∞', notes: '' }
    ]
  });

  const loadInitialShopping = () => [
    { id: 1, item: '–ö–æ—Å—Ç—é–º —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π', priority: '–ö–†–ò–¢–ò–ß–ù–û', price: '‚Ç¨400-700', category: '–°—É–¥–µ–π—Å—Ç–≤–æ', plannedDate: '', purchased: false },
    { id: 2, item: '–¢—É—Ñ–ª–∏ —á–µ—Ä–Ω—ã–µ', priority: '–ö–†–ò–¢–ò–ß–ù–û', price: '‚Ç¨200-400', category: '–°—É–¥–µ–π—Å—Ç–≤–æ', plannedDate: '', purchased: false },
    { id: 3, item: '–¢—É—Ñ–ª–∏ burgundy', priority: '–ö–†–ò–¢–ò–ß–ù–û', price: '‚Ç¨200-300', category: '–ò–∑—é–º–∏–Ω–∫–∞', plannedDate: '', purchased: false }
  ];

  const loadInitialOutfits = () => [
    {
      id: 1,
      name: '–≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä',
      category: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
      season: '–∑–∏–º–∞',
      items: ['–í–æ–¥–æ–ª–∞–∑–∫–∞ —Å–∏–Ω—è—è', '–ñ–∏–ª–µ—Ç–∫–∞ —Å–∏–Ω—è—è', '–ë—Ä—é–∫–∏ —Å–µ—Ä—ã–µ', '–ß–µ–ª—Å–∏ —á–µ—Ä–Ω—ã–µ'],
      complete: true
    }
  ];

  const saveData = async (key, data, setter) => {
    try {
      await window.storage.set(key, JSON.stringify(data));
      setter(data);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
    }
  };

  // ---- Instrumented actions ----
  const addWardrobeItem = async () => {
    if (!newItem.name) return;
    const category = newItem.category;
    const item = { ...newItem, id: Date.now() };
    const updated = {
      ...wardrobeItems,
      [category]: [...(wardrobeItems[category] || []), item]
    };
    await saveData('wardrobe-data-v2', updated, setWardrobeItems);
    trackEvent('add_item', { category, name: item.name, priority: item.priority, status: item.status });
    setNewItem({ name: '', category: 'suits', status: '–µ—Å—Ç—å', priority: '–Ω–∏–∑–∫–∏–π', tags: '', notes: '', photo: '' });
  };

  const deleteWardrobeItem = async (category, itemId) => {
    const itemToDelete = (wardrobeItems[category] || []).find(i => i.id === itemId);
    const updated = {
      ...wardrobeItems,
      [category]: wardrobeItems[category].filter(item => item.id !== itemId)
    };
    await saveData('wardrobe-data-v2', updated, setWardrobeItems);
    trackEvent('delete_item', { category, id: itemId, name: itemToDelete?.name });
  };

  const updateWardrobeItem = async (category, itemId, updates) => {
    const prev = (wardrobeItems[category] || []).find(i => i.id === itemId);
    const updated = {
      ...wardrobeItems,
      [category]: wardrobeItems[category].map(item =>
        item.id === itemId ? { ...item, ...updates } : item
      )
    };
    await saveData('wardrobe-data-v2', updated, setWardrobeItems);
    setEditingItem(null);
    trackEvent('update_item', { category, id: itemId, before: { name: prev?.name, status: prev?.status, priority: prev?.priority }, after: { name: updates.name || prev?.name, status: updates.status || prev?.status, priority: updates.priority || prev?.priority } });
  };

  const addShoppingItem = async (item) => {
    const newObj = { ...item, id: Date.now(), purchased: false };
    const updated = [...shoppingList, newObj];
    await saveData('shopping-data-v2', updated, setShoppingList);
    trackEvent('add_shopping', { item: newObj.item, price: newObj.price, priority: newObj.priority });
  };

  const removeShoppingItem = async (id) => {
    const item = shoppingList.find(i => i.id === id);
    const updated = shoppingList.filter(i => i.id !== id);
    await saveData('shopping-data-v2', updated, setShoppingList);
    trackEvent('remove_shopping', { id, item: item?.item });
  };

  const togglePurchased = async (id) => {
    const updated = shoppingList.map(item =>
      item.id === id ? { ...item, purchased: !item.purchased, purchasedDate: !item.purchased ? new Date().toISOString().split('T')[0] : null } : item
    );
    await saveData('shopping-data-v2', updated, setShoppingList);
    const toggled = updated.find(i => i.id === id);
    trackEvent('toggle_purchased', { id, item: toggled?.item, purchased: toggled?.purchased });
  };

  const addOutfit = async (outfit) => {
    const newObj = { ...outfit, id: Date.now() };
    const updated = [...outfits, newObj];
    await saveData('outfits-data-v2', updated, setOutfits);
    trackEvent('add_outfit', { name: newObj.name, items: newObj.items });
  };

  const deleteOutfit = async (id) => {
    const outfit = outfits.find(o => o.id === id);
    const updated = outfits.filter(o => o.id !== id);
    await saveData('outfits-data-v2', updated, setOutfits);
    trackEvent('delete_outfit', { id, name: outfit?.name });
  };

  const addLink = async (link) => {
    const updated = [...inspirationLinks, { id: Date.now(), url: link }];
    await saveData('inspiration-data-v2', updated, setInspirationLinks);
    trackEvent('add_link', { url: link });
  };

  const removeLink = async (id) => {
    const link = inspirationLinks.find(l => l.id === id);
    const updated = inspirationLinks.filter(l => l.id !== id);
    await saveData('inspiration-data-v2', updated, setInspirationLinks);
    trackEvent('remove_link', { id, url: link?.url });
  };

  const handlePhotoUpload = (e, itemId, category) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const photoData = reader.result;
        if (itemId) {
          updateWardrobeItem(category, itemId, { photo: photoData });
        } else {
          setNewItem({...newItem, photo: photoData});
        }
        trackEvent('upload_photo', { itemId: itemId || null, category });
      };
      reader.readAsDataURL(file);
    }
  };

  const removePhoto = (itemId, category) => {
    if (itemId) {
      updateWardrobeItem(category, itemId, { photo: '' });
    } else {
      setNewItem({...newItem, photo: ''});
    }
    trackEvent('remove_photo', { itemId: itemId || null, category });
  };

  // ---- Utilities & stats ----
  const getStats = () => {
    const all = Object.values(wardrobeItems).flat();
    const owned = all.filter(i => i.status === '–µ—Å—Ç—å').length;
    const needed = all.filter(i => i.status !== '–µ—Å—Ç—å').length;
    const critical = all.filter(i => i.priority === '–∫—Ä–∏—Ç–∏—á–Ω—ã–π' || i.priority === '–ö–†–ò–¢–ò–ß–ù–û').length;
    const total = all.length;
    const completion = total > 0 ? Math.round((owned / total) * 100) : 0;
    const shoppingTotal = shoppingList.reduce((sum, item) => {
      const match = item.price?.match(/‚Ç¨(\d+)/);
      return sum + (match ? parseInt(match[1]) : 0);
    }, 0);
    return { total, owned, needed, critical, completion, shoppingTotal };
  };

  const checkOutfit = (outfit) => {
    const all = Object.values(wardrobeItems).flat();
    const missing = outfit.items.filter(outfitItem => 
      !all.some(w => w.name.toLowerCase().includes(outfitItem.toLowerCase()) && w.status === '–µ—Å—Ç—å')
    );
    return { complete: missing.length === 0, missing };
  };

  const exportText = (data, filename) => {
    const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  };

  const exportShopping = () => {
    const text = shoppingList.map(i => `${i.item} - ${i.priority} - ${i.price} - ${i.category} ${i.purchased ? `(–∫—É–ø–ª–µ–Ω–æ ${i.purchasedDate || ''})` : ''}`).join('\n');
    exportText(text, 'shopping-list.txt');
    trackEvent('export_shopping', { count: shoppingList.length });
  };

  const exportWardrobe = () => {
    const text = Object.entries(wardrobeItems).map(([cat, items]) =>
      `\n=== ${cat.toUpperCase()} ===\n` + items.map(i => `${i.name} - ${i.status} - ${i.priority} - ${i.tags || ''}`).join('\n')
    ).join('\n');
    exportText(text, 'wardrobe.txt');
    trackEvent('export_wardrobe', { categories: Object.keys(wardrobeItems).length });
  };

  // ---- New analytics reports ----
  const computeCategoryStats = () => {
    const cats = Object.entries(wardrobeItems);
    return cats.map(([cat, items]) => {
      const total = items.length;
      const owned = items.filter(i => i.status === '–µ—Å—Ç—å').length;
      const needed = total - owned;
      const percent = total > 0 ? Math.round((owned / total) * 100) : 0;
      return { category: cat, total, owned, needed, percent };
    });
  };

  const getTopTags = (topN = 10) => {
    const all = Object.values(wardrobeItems).flat();
    const map = {};
    all.forEach(i => {
      const tags = (i.tags || '').split(',').map(t => t.trim().toLowerCase()).filter(t => t);
      tags.forEach(t => map[t] = (map[t] || 0) + 1);
    });
    return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0, topN).map(([tag,count]) => ({tag, count}));
  };

  const getPriorityStats = () => {
    const all = Object.values(wardrobeItems).flat();
    const map = {};
    all.forEach(i => {
      const p = (i.priority || '–Ω–∏–∑–∫–∏–π').toString();
      map[p] = (map[p] || 0) + 1;
    });
    return Object.entries(map).map(([priority, count]) => ({ priority, count }));
  };

  const getPurchaseHistoryLast = (n = 10) => {
    const purchased = shoppingList.filter(i => i.purchased).slice();
    purchased.sort((a,b) => {
      const da = a.purchasedDate ? new Date(a.purchasedDate).getTime() : a.id;
      const db = b.purchasedDate ? new Date(b.purchasedDate).getTime() : b.id;
      return db - da;
    });
    return purchased.slice(0, n);
  };

  const getPurchasesByMonth = () => {
    const purchased = shoppingList.filter(i => i.purchased && i.purchasedDate);
    const map = {};
    purchased.forEach(p => {
      const d = new Date(p.purchasedDate);
      if (isNaN(d)) return;
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      map[key] = map[key] || [];
      map[key].push(p);
    });
    const entries = Object.entries(map).sort((a,b)=>b[0].localeCompare(a[0])); // recent first
    return entries.map(([month, items]) => ({ month, items }));
  };

  const getRecommendations = () => {
    const recs = [];
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –≤–µ—â–µ–π: –µ—Å–ª–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç owned >=1 -> —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º
    const catStats = computeCategoryStats();
    const basicsMissing = catStats.filter(cs => cs.owned === 0).map(cs => cs.category);
    if (basicsMissing.length > 0) {
      recs.push({ title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –≤–µ—â–µ–π', text: `–í –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–µ—â–∏: ${basicsMissing.join(', ')}.` });
    } else {
      recs.push({ title: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –≤–µ—â–µ–π', text: '–ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.' });
    }
    // –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
    const criticals = shoppingList.filter(s => {
      const p = (s.priority || '').toString().toLowerCase();
      return p.includes('–∫—Ä–∏—Ç') || p.includes('–∫—Ä–∏—Ç–∏—á–Ω—ã–π');
    });
    if (criticals.length > 0) {
      recs.push({ title: '–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏', text: criticals.map(c => `${c.item} ${c.price ? `(${c.price})` : ''}`).join('; ') });
    } else {
      recs.push({ title: '–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏', text: '–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫.' });
    }
    // –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
    const incomplete = outfits.map(o => ({ ...o, check: checkOutfit(o) })).filter(o => !o.check.complete);
    if (incomplete.length > 0) {
      recs.push({ title: '–ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã', text: incomplete.map(i => `${i.name}: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${i.check.missing.join(', ')}`).join('\n') });
    } else {
      recs.push({ title: '–ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã', text: '–í—Å–µ –æ–±—Ä–∞–∑—ã —Å–æ–±—Ä–∞–Ω—ã.' });
    }
    return recs;
  };

  const exportFullReport = () => {
    const s = getStats();
    const cat = computeCategoryStats();
    const tags = getTopTags(50);
    const pr = getPriorityStats();
    const purchases = getPurchaseHistoryLast(50);
    const purchasesByMonth = getPurchasesByMonth();
    const recs = getRecommendations();

    let txt = '';
    txt += `–û—Ç—á—ë—Ç: –ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–±\n–î–∞—Ç–∞: ${new Date().toISOString()}\n\n`;
    txt += `–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:\n`;
    txt += `- –í—Å–µ–≥–æ –≤–µ—â–µ–π: ${s.total}\n- –ï—Å—Ç—å: ${s.owned}\n- –ù—É–∂–Ω–æ: ${s.needed}\n- –ö—Ä–∏—Ç–∏—á–Ω—ã—Ö: ${s.critical}\n- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${s.completion}%\n- –ë—é–¥–∂–µ—Ç –≤ —à–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç–µ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ): ‚Ç¨${s.shoppingTotal}+\n\n`;

    txt += `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n`;
    cat.forEach(c => {
      txt += `- ${c.category}: ${c.owned}/${c.total} (–ø—Ä–æ—Ü–µ–Ω—Ç: ${c.percent}%)\n`;
    });
    txt += `\n–¢–æ–ø —Ç–µ–≥–æ–≤:\n`;
    tags.forEach(t => txt += `- ${t.tag}: ${t.count}\n`);
    txt += `\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:\n`;
    pr.forEach(p => txt += `- ${p.priority}: ${p.count}\n`);

    txt += `\n–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${purchases.length}):\n`;
    purchases.forEach(p => txt += `- ${p.item} ${p.price ? `(${p.price})` : ''} –∫—É–ø–ª–µ–Ω–æ: ${p.purchasedDate || '–Ω–µ—Ç –¥–∞—Ç—ã'}\n`);

    txt += `\n–ü–æ–∫—É–ø–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º:\n`;
    purchasesByMonth.forEach(m => {
      txt += `\n${m.month}:\n`;
      m.items.forEach(it => txt += `  - ${it.item} (${it.purchasedDate || ''})\n`);
    });

    txt += `\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n`;
    getRecommendations().forEach(r => {
      txt += `\n${r.title}:\n${r.text}\n`;
    });

    exportText(txt, 'wardrobe-full-report.txt');
    trackEvent('export_full_report', { totalItems: s.total, shoppingTotal: s.shoppingTotal });
  };

  // ---- UI helpers ----
  const categories = [
    { id: 'all', name: '–í—Å–µ' },
    { id: 'suits', name: '–ö–æ—Å—Ç—é–º—ã' },
    { id: 'shirts', name: '–†—É–±–∞—à–∫–∏' },
    { id: 'knitwear', name: '–¢—Ä–∏–∫–æ—Ç–∞–∂' },
    { id: 'polo', name: '–ü–æ–ª–æ' },
    { id: 'pants', name: '–ë—Ä—é–∫–∏' },
    { id: 'shoes', name: '–û–±—É–≤—å' },
    { id: 'accessories', name: '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã' }
  ];

  const getPriorityColor = (p) => {
    if (p === '–∫—Ä–∏—Ç–∏—á–Ω—ã–π' || p === '–ö–†–ò–¢–ò–ß–ù–û') return 'bg-red-900 text-red-100';
    if (p === '–≤—ã—Å–æ–∫–∏–π' || p === '–í–´–°–û–ö–ò–ô') return 'bg-orange-900 text-orange-100';
    if (p === '—Å—Ä–µ–¥–Ω–∏–π' || p === '–°–†–ï–î–ù–ò–ô') return 'bg-yellow-900 text-yellow-100';
    return 'bg-gray-700 text-gray-300';
  };

  const getStatusBadge = (s) => {
    if (s === '–Ω—É–∂–µ–Ω' || s === '–Ω—É–∂–Ω–∞' || s === '–Ω—É–∂–Ω—ã') 
      return <span className="px-2 py-1 bg-red-900 text-red-100 rounded text-xs">–ù—É–∂–Ω–æ</span>;
    return <span className="px-2 py-1 bg-green-900 text-green-100 rounded text-xs">–ï—Å—Ç—å</span>;
  };

  if (isLoading) return (
    <div className="min-h-screen bg-gray-900 flex items-center justify-center">
      <div className="text-white text-xl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  );

  const stats = getStats();

  // ---- Rendering analytics dashboard ----
  const renderAnalytics = () => {
    const catStats = computeCategoryStats();
    const topTags = getTopTags(10);
    const priorityStats = getPriorityStats();
    const recentPurchases = getPurchaseHistoryLast(10);
    const purchasesByMonth = getPurchasesByMonth();
    const recs = getRecommendations();

    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between gap-4">
          <h2 className="text-white text-xl font-bold flex items-center gap-2"><TrendingUp className="w-5 h-5" />–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
          <div className="flex gap-2">
            <button onClick={exportFullReport} className="px-3 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded flex items-center gap-2">
              <Download className="w-4 h-4" /> –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç
            </button>
            <button onClick={() => { setShowAnalytics(false); trackEvent('analytics_close'); }} className="px-3 py-2 bg-gray-700 text-white rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div className="text-gray-400 text-xs">–û–±—â–µ–µ</div>
            <div className="text-white text-2xl font-bold">{stats.total} –≤–µ—â–µ–π</div>
            <div className="flex gap-2 mt-3">
              <div className="text-green-400 font-bold">{stats.owned} –µ—Å—Ç—å</div>
              <div className="text-red-400 font-bold">{stats.needed} –Ω—É–∂–Ω–æ</div>
            </div>
            <div className="mt-3">
              <div className="text-gray-400 text-xs">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
              <div className="w-full bg-gray-700 h-3 rounded mt-1 overflow-hidden">
                <div className="bg-blue-500 h-3" style={{ width: `${stats.completion}%` }} />
              </div>
              <div className="text-sm mt-1">{stats.completion}%</div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div className="text-gray-400 text-xs">–í —à–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç–µ (–Ω–µ –∫—É–ø–ª–µ–Ω–æ)</div>
            <div className="text-yellow-300 text-2xl font-bold">{shoppingList.filter(i => !i.purchased).length}</div>
            <div className="text-gray-400 text-xs mt-2">–ü—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç: ‚Ç¨{stats.shoppingTotal}+</div>
            <div className="mt-3">
              <div className="text-gray-400 text-xs">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div>
              <div className="text-red-500 text-2xl font-bold">{stats.critical}</div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div className="text-gray-400 text-xs">–°–æ–±—ã—Ç–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>
            <div className="text-white font-bold text-lg mt-2">{analyticsEvents.length}</div>
            <div className="text-gray-400 text-xs mt-2">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</div>
            <div className="max-h-28 overflow-auto text-sm text-gray-300 mt-1">
              {analyticsEvents.slice(-8).reverse().map(e => (
                <div key={e.id} className="text-xs border-b border-gray-700 py-1">
                  <div className="text-gray-300">{e.type}</div>
                  <div className="text-gray-500 text-[11px]">{new Date(e.ts).toLocaleString()}</div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h3 className="text-white font-medium mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
            <div className="space-y-2">
              {catStats.map(c => (
                <div key={c.category} className="space-y-1">
                  <div className="flex justify-between text-sm text-gray-300">
                    <div>{c.category}</div>
                    <div>{c.owned}/{c.total} ({c.percent}%)</div>
                  </div>
                  <div className="w-full bg-gray-700 h-3 rounded overflow-hidden">
                    <div className="bg-green-500 h-3" style={{ width: `${c.percent}%` }} />
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h3 className="text-white font-medium mb-2">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏</h3>
            <div className="space-y-2">
              {topTags.length === 0 && <div className="text-gray-400">–¢–µ–≥–æ–≤ –Ω–µ—Ç</div>}
              {topTags.map(t => (
                <div key={t.tag} className="flex justify-between text-sm text-gray-300">
                  <div>#{t.tag}</div>
                  <div className="text-yellow-300 font-bold">{t.count}</div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h4 className="text-white font-medium mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</h4>
            <div className="space-y-2">
              {priorityStats.map(p => (
                <div key={p.priority} className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-full ${p.priority === '–∫—Ä–∏—Ç–∏—á–Ω—ã–π' || p.priority.toLowerCase().includes('–∫—Ä–∏—Ç') ? 'bg-red-500' : p.priority.toLowerCase().includes('–≤—ã—Å–æ–∫') ? 'bg-orange-500' : p.priority.toLowerCase().includes('—Å—Ä–µ–¥–Ω') ? 'bg-yellow-500' : 'bg-gray-500'}`} />
                    <div className="text-sm text-gray-300">{p.priority}</div>
                  </div>
                  <div className="text-white font-bold">{p.count}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700 md:col-span-2">
            <h4 className="text-white font-medium mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
            <div className="space-y-2">
              {recs.map((r, idx) => (
                <div key={idx} className="bg-gray-900 p-3 rounded border border-gray-700">
                  <div className="text-sm text-yellow-200 font-semibold">{r.title}</div>
                  <div className="text-sm text-gray-300 whitespace-pre-wrap mt-1">{r.text}</div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h4 className="text-white font-medium mb-2">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)</h4>
            <div className="space-y-2 text-sm">
              {recentPurchases.length === 0 && <div className="text-gray-400">–ù–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –≤–µ—â–µ–π</div>}
              {recentPurchases.map(p => (
                <div key={p.id} className="flex justify-between items-center">
                  <div className="text-gray-200">{p.item}</div>
                  <div className="text-gray-400 text-xs">{p.purchasedDate || '‚Äî'}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h4 className="text-white font-medium mb-2">–ü–æ–∫—É–ø–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</h4>
            <div className="space-y-2 text-sm">
              {purchasesByMonth.length === 0 && <div className="text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–µ—Å—è—Ü–∞–º</div>}
              {purchasesByMonth.map(m => (
                <div key={m.month} className="border-b border-gray-700 pb-2 mb-2">
                  <div className="text-yellow-300 font-semibold">{m.month}</div>
                  {m.items.map(it => <div key={it.id} className="text-gray-300 text-sm">- {it.item} ({it.purchasedDate})</div>)}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  // ---- Rendering wardrobe list (original) ----
  const renderWardrobe = () => {
    let items = selectedCategory === 'all' 
      ? Object.entries(wardrobeItems).flatMap(([cat, its]) => its.map(i => ({...i, category: cat})))
      : (wardrobeItems[selectedCategory] || []).map(i=>({...i, category: selectedCategory}));

    if (searchQuery) {
      items = items.filter(i => 
        i.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        i.tags?.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    if (filterStatus === 'owned') items = items.filter(i => i.status === '–µ—Å—Ç—å');
    if (filterStatus === 'needed') items = items.filter(i => i.status !== '–µ—Å—Ç—å');
    if (filterPriority !== 'all') items = items.filter(i => i.priority === filterPriority);

    return (
      <div className="space-y-4">
        {showStats && (
          <div className="bg-gradient-to-r from-gray-800 to-gray-700 rounded-lg p-4 border border-gray-600">
            <div className="flex justify-between mb-3">
              <h3 className="text-white font-bold flex items-center gap-2">
                <TrendingUp className="w-5 h-5" />
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
              </h3>
              <button onClick={() => setShowStats(false)} className="text-gray-400 hover:text-white">
                <X className="w-4 h-4" />
              </button>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              <div className="bg-gray-900 rounded p-3">
                <div className="text-gray-400 text-xs">–í—Å–µ–≥–æ –≤–µ—â–µ–π</div>
                <div className="text-white text-2xl font-bold">{stats.total}</div>
              </div>
              <div className="bg-gray-900 rounded p-3">
                <div className="text-gray-400 text-xs">–ï—Å—Ç—å</div>
                <div className="text-green-400 text-2xl font-bold">{stats.owned}</div>
              </div>
              <div className="bg-gray-900 rounded p-3">
                <div className="text-gray-400 text-xs">–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å</div>
                <div className="text-red-400 text-2xl font-bold">{stats.needed}</div>
              </div>
              <div className="bg-gray-900 rounded p-3">
                <div className="text-gray-400 text-xs">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div>
                <div className="text-red-500 text-2xl font-bold">{stats.critical}</div>
              </div>
              <div className="bg-gray-900 rounded p-3">
                <div className="text-gray-400 text-xs">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
                <div className="text-blue-400 text-2xl font-bold">{stats.completion}%</div>
              </div>
              <div className="bg-gray-900 rounded p-3">
                <div className="text-gray-400 text-xs">–í —à–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç–µ</div>
                <div className="text-orange-400 text-2xl font-bold">{shoppingList.filter(i => !i.purchased).length}</div>
              </div>
            </div>
          </div>
        )}

        <div className="bg-gray-800 rounded-lg p-4 border border-gray-700 space-y-3">
          <div className="flex gap-2">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
              <input
                type="text"
                placeholder="–ü–æ–∏—Å–∫..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-10 pr-3 py-2 bg-gray-900 text-white rounded border border-gray-700"
              />
            </div>
            {searchQuery && (
              <button onClick={() => setSearchQuery('')} className="px-3 bg-gray-700 rounded">
                <X className="w-4 h-4 text-white" />
              </button>
            )}
          </div>

          <div className="flex gap-2 flex-wrap">
            <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}
              className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700 text-sm">
              <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="owned">–¢–æ–ª—å–∫–æ –µ—Å—Ç—å</option>
              <option value="needed">–¢–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ</option>
            </select>

            <select value={filterPriority} onChange={(e) => setFilterPriority(e.target.value)}
              className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700 text-sm">
              <option value="all">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
              <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
              <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
              <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
            </select>

            <div className="flex gap-1 ml-auto">
              <button
                onClick={() => setViewMode('list')}
                className={`p-2 rounded ${viewMode === 'list' ? 'bg-red-900 text-white' : 'bg-gray-700 text-gray-300'}`}
                title="–°–ø–∏—Å–æ–∫"
              >
                <List className="w-4 h-4" />
              </button>
              <button
                onClick={() => setViewMode('grid')}
                className={`p-2 rounded ${viewMode === 'grid' ? 'bg-red-900 text-white' : 'bg-gray-700 text-gray-300'}`}
                title="–°–µ—Ç–∫–∞"
              >
                <Grid className="w-4 h-4" />
              </button>
              <button
                onClick={() => { setShowAnalytics(s => !s); trackEvent('toggle_analytics', { open: !showAnalytics }); }}
                className={`p-2 rounded ${showAnalytics ? 'bg-blue-700 text-white' : 'bg-gray-700 text-gray-300'}`}
                title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"
              >
                üìä
              </button>
            </div>

            <button onClick={exportWardrobe}
              className="px-3 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded text-sm flex items-center gap-2">
              <Download className="w-4 h-4" />
              –≠–∫—Å–ø–æ—Ä—Ç
            </button>
          </div>
        </div>

        <div className="flex gap-2 overflow-x-auto pb-2">
          {categories.map(cat => (
            <button key={cat.id} onClick={() => setSelectedCategory(cat.id)}
              className={`px-4 py-2 rounded-lg whitespace-nowrap transition ${
                selectedCategory === cat.id ? 'bg-red-900 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
              }`}>
              {cat.name}
            </button>
          ))}
        </div>

        {/* Add item card omitted for brevity ‚Äî kept identical to original for UI parity */}
        <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <h3 className="text-white font-medium mb-3">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å</h3>
          <div className="space-y-3">
            <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value={newItem.name}
              onChange={(e) => setNewItem({...newItem, name: e.target.value})}
              className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            
            <div className="grid grid-cols-3 gap-2">
              <select value={newItem.category} onChange={(e) => setNewItem({...newItem, category: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                {categories.filter(c => c.id !== 'all').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <select value={newItem.status} onChange={(e) => setNewItem({...newItem, status: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                <option value="–µ—Å—Ç—å">–ï—Å—Ç—å</option>
                <option value="–Ω—É–∂–µ–Ω">–ù—É–∂–µ–Ω</option>
              </select>
              <select value={newItem.priority} onChange={(e) => setNewItem({...newItem, priority: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
              </select>
            </div>
            
            <input type="text" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" value={newItem.tags}
              onChange={(e) => setNewItem({...newItem, tags: e.target.value})}
              className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            
            <textarea placeholder="–ó–∞–º–µ—Ç–∫–∏" value={newItem.notes} rows="2"
              onChange={(e) => setNewItem({...newItem, notes: e.target.value})}
              className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />

            <div className="space-y-2">
              <div className="text-gray-400 text-sm">–§–æ—Ç–æ –≤–µ—â–∏</div>
              {newItem.photo ? (
                <div className="relative">
                  <img src={newItem.photo} alt="Preview" className="w-full h-40 object-cover rounded border border-gray-700" />
                  <button
                    onClick={() => removePhoto()}
                    className="absolute top-2 right-2 p-1 bg-red-900 hover:bg-red-800 rounded"
                  >
                    <X className="w-4 h-4 text-white" />
                  </button>
                </div>
              ) : (
                <label className="flex items-center justify-center gap-2 w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded cursor-pointer border-2 border-dashed border-gray-600">
                  <Camera className="w-5 h-5" />
                  <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => handlePhotoUpload(e)}
                    className="hidden"
                  />
                </label>
              )}
            </div>

            <button onClick={addWardrobeItem}
              className="w-full px-4 py-2 bg-red-900 hover:bg-red-800 text-white rounded transition">
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>

        {/* Items list / grid */}
        <div className={viewMode === 'list' ? 'grid gap-3' : 'hidden'}>
          {items.map(item => (
            <div key={item.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
              {editingItem === item.id ? (
                <div className="space-y-3">
                  <input type="text" value={item.name}
                    onChange={(e) => {
                      const u = {...wardrobeItems, [item.category || selectedCategory]: 
                        (wardrobeItems[item.category || selectedCategory] || []).map(i => i.id === item.id ? {...i, name: e.target.value} : i)};
                      setWardrobeItems(u);
                    }}
                    className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
                  
                  <div className="grid grid-cols-2 gap-2">
                    <select value={item.status}
                      onChange={(e) => {
                        const u = {...wardrobeItems, [item.category || selectedCategory]: 
                          (wardrobeItems[item.category || selectedCategory] || []).map(i => i.id === item.id ? {...i, status: e.target.value} : i)};
                        setWardrobeItems(u);
                      }}
                      className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                      <option value="–µ—Å—Ç—å">–ï—Å—Ç—å</option>
                      <option value="–Ω—É–∂–µ–Ω">–ù—É–∂–µ–Ω</option>
                      <option value="–Ω—É–∂–Ω–∞">–ù—É–∂–Ω–∞</option>
                      <option value="–Ω—É–∂–Ω—ã">–ù—É–∂–Ω—ã</option>
                    </select>
                    <select value={item.priority}
                      onChange={(e) => {
                        const u = {...wardrobeItems, [item.category || selectedCategory]: 
                          (wardrobeItems[item.category || selectedCategory] || []).map(i => i.id === item.id ? {...i, priority: e.target.value} : i)};
                        setWardrobeItems(u);
                      }}
                      className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                      <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                      <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                      <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                      <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                    </select>
                  </div>

                  <input type="text" placeholder="–¢–µ–≥–∏" value={item.tags || ''}
                    onChange={(e) => {
                      const u = {...wardrobeItems, [item.category || selectedCategory]: 
                        (wardrobeItems[item.category || selectedCategory] || []).map(i => i.id === item.id ? {...i, tags: e.target.value} : i)};
                      setWardrobeItems(u);
                    }}
                    className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />

                  <textarea placeholder="–ó–∞–º–µ—Ç–∫–∏" value={item.notes || ''} rows="2"
                    onChange={(e) => {
                      const u = {...wardrobeItems, [item.category || selectedCategory]: 
                        (wardrobeItems[item.category || selectedCategory] || []).map(i => i.id === item.id ? {...i, notes: e.target.value} : i)};
                      setWardrobeItems(u);
                    }}
                    className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />

                  <div className="space-y-2">
                    <div className="text-gray-400 text-sm">–§–æ—Ç–æ</div>
                    {item.photo ? (
                      <div className="relative">
                        <img src={item.photo} alt={item.name} className="w-full h-40 object-cover rounded" />
                        <button
                          onClick={() => {
                            const u = {...wardrobeItems, [item.category || selectedCategory]: 
                              (wardrobeItems[item.category || selectedCategory] || []).map(i => i.id === item.id ? {...i, photo: ''} : i)};
                            setWardrobeItems(u);
                          }}
                          className="absolute top-2 right-2 p-1 bg-red-900 hover:bg-red-800 rounded"
                        >
                          <X className="w-4 h-4 text-white" />
                        </button>
                      </div>
                    ) : (
                      <label className="flex items-center justify-center gap-2 w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded cursor-pointer">
                        <Camera className="w-5 h-5" />
                        <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                        <input
                          type="file"
                          accept="image/*"
                          onChange={(e) => handlePhotoUpload(e, item.id, item.category || selectedCategory)}
                          className="hidden"
                        />
                      </label>
                    )}
                  </div>
                  
                  <div className="flex gap-2">
                    <button onClick={() => updateWardrobeItem(item.category || selectedCategory, item.id, item)}
                      className="flex-1 px-4 py-2 bg-green-900 hover:bg-green-800 text-white rounded flex items-center justify-center gap-2">
                      <Save className="w-4 h-4" />
                      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button onClick={() => setEditingItem(null)}
                      className="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded">
                      –û—Ç–º–µ–Ω–∞
                    </button>
                  </div>
                </div>
              ) : (
                <div className="flex items-start gap-4">
                  {item.photo && (
                    <img src={item.photo} alt={item.name} className="w-24 h-24 object-cover rounded flex-shrink-0" />
                  )}
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <h3 className="text-white font-medium">{item.name}</h3>
                      {item.count && <span className="text-gray-400 text-sm">({item.count} —à—Ç)</span>}
                      {item.signature && <Star className="w-4 h-4 text-yellow-500 fill-yellow-500" />}
                    </div>
                    <div className="flex items-center gap-2 mb-2">
                      {getStatusBadge(item.status)}
                      <span className={`px-2 py-1 rounded text-xs ${getPriorityColor(item.priority)}`}>
                        {item.priority}
                      </span>
                    </div>
                    {item.tags && (
                      <div className="flex items-center gap-1 text-xs text-gray-400 mb-1">
                        <Tag className="w-3 h-3" />
                        {item.tags}
                      </div>
                    )}
                    {item.notes && (
                      <div className="text-xs text-gray-400 italic">{item.notes}</div>
                    )}
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingItem(item.id)} className="p-2 hover:bg-blue-900 rounded">
                      <Edit2 className="w-4 h-4 text-gray-400 hover:text-blue-400" />
                    </button>
                    <button onClick={() => deleteWardrobeItem(item.category || selectedCategory, item.id)}
                      className="p-2 hover:bg-red-900 rounded">
                      <Trash2 className="w-4 h-4 text-gray-400 hover:text-red-400" />
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>

        {viewMode === 'grid' && !editingItem && (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {items.map(item => (
              <div key={item.id} className="bg-gray-800 rounded-lg overflow-hidden border border-gray-700 hover:border-red-900 transition">
                <div className="relative">
                  {item.photo ? (
                    <img src={item.photo} alt={item.name} className="w-full h-48 object-cover" />
                  ) : (
                    <div className="w-full h-48 bg-gray-700 flex items-center justify-center">
                      <Image className="w-12 h-12 text-gray-600" />
                    </div>
                  )}
                  {item.signature && (
                    <div className="absolute top-2 right-2 bg-yellow-500 rounded-full p-1">
                      <Star className="w-4 h-4 text-yellow-900 fill-yellow-900" />
                    </div>
                  )}
                  <div className="absolute bottom-2 left-2 right-2 flex gap-1">
                    {getStatusBadge(item.status)}
                  </div>
                </div>
                <div className="p-3">
                  <h3 className="text-white font-medium text-sm mb-2 line-clamp-2">{item.name}</h3>
                  <div className="flex items-center justify-between">
                    <span className={`px-2 py-1 rounded text-xs ${getPriorityColor(item.priority)}`}>
                      {item.priority}
                    </span>
                    <div className="flex gap-1">
                      <button onClick={() => setEditingItem(item.id)} className="p-1 hover:bg-blue-900 rounded">
                        <Edit2 className="w-3 h-3 text-gray-400" />
                      </button>
                      <button onClick={() => deleteWardrobeItem(item.category || selectedCategory, item.id)}
                        className="p-1 hover:bg-red-900 rounded">
                        <Trash2 className="w-3 h-3 text-gray-400" />
                      </button>
                    </div>
                  </div>
                  {item.tags && (
                    <div className="flex items-center gap-1 text-xs text-gray-400 mt-2">
                      <Tag className="w-3 h-3" />
                      <span className="line-clamp-1">{item.tags}</span>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}

        {items.length === 0 && (
          <div className="text-center text-gray-400 py-8">
            –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.
          </div>
        )}
      </div>
    );
  };

  const renderShoppingList = () => {
    const activePurchases = shoppingList.filter(i => !i.purchased);
    const completedPurchases = shoppingList.filter(i => i.purchased);

    return (
      <div className="space-y-4">
        <div className="bg-gradient-to-r from-yellow-900 to-orange-900 rounded-lg p-4">
          <div className="text-white font-bold text-lg mb-1">–ë—é–¥–∂–µ—Ç –Ω–∞ –ø–æ–∫—É–ø–∫–∏</div>
          <div className="text-yellow-200 text-3xl font-bold">‚Ç¨{stats.shoppingTotal}+</div>
          <div className="text-yellow-200 text-sm mt-1">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫: {activePurchases.length}</div>
        </div>

        <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <h3 className="text-white font-medium mb-3">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</h3>
          <div className="space-y-3">
            <input type="text" placeholder="–ß—Ç–æ –∫—É–ø–∏—Ç—å" value={newShop.item}
              onChange={(e) => setNewShop({...newShop, item: e.target.value})}
              className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            
            <div className="grid grid-cols-2 gap-2">
              <select value={newShop.priority} onChange={(e) => setNewShop({...newShop, priority: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                <option value="–ö–†–ò–¢–ò–ß–ù–û">–ö—Ä–∏—Ç–∏—á–Ω–æ</option>
                <option value="–í–´–°–û–ö–ò–ô">–í—ã—Å–æ–∫–∏–π</option>
                <option value="–°–†–ï–î–ù–ò–ô">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="–ù–ò–ó–ö–ò–ô">–ù–∏–∑–∫–∏–π</option>
              </select>
              <input type="text" placeholder="–¶–µ–Ω–∞ (‚Ç¨100-200)" value={newShop.price}
                onChange={(e) => setNewShop({...newShop, price: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            </div>

            <div className="grid grid-cols-2 gap-2">
              <input type="text" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" value={newShop.category}
                onChange={(e) => setNewShop({...newShop, category: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
              <input type="date" value={newShop.plannedDate}
                onChange={(e) => setNewShop({...newShop, plannedDate: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            </div>

            <button onClick={() => {
              if (newShop.item) {
                addShoppingItem(newShop);
                setNewShop({ item: '', priority: '–°–†–ï–î–ù–ò–ô', price: '', category: '', plannedDate: '' });
              }
            }}
              className="w-full px-4 py-2 bg-red-900 hover:bg-red-800 text-white rounded">
              –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>

        <div className="flex justify-end">
          <button onClick={exportShopping}
            className="px-4 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded flex items-center gap-2">
            <Download className="w-4 h-4" />
            –≠–∫—Å–ø–æ—Ä—Ç —Å–ø–∏—Å–∫–∞
          </button>
        </div>

        <div>
          <h3 className="text-white font-bold mb-3 flex items-center gap-2">
            <ShoppingBag className="w-5 h-5" />
            –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ ({activePurchases.length})
          </h3>
          <div className="space-y-3">
            {activePurchases.map(item => (
              <div key={item.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <button onClick={() => togglePurchased(item.id)}
                        className="w-6 h-6 rounded border-2 border-gray-600 hover:border-green-500 flex items-center justify-center">
                        {item.purchased && <Check className="w-4 h-4 text-green-500" />}
                      </button>
                      <h3 className="text-white font-medium">{item.item}</h3>
                    </div>
                    <div className="flex items-center gap-2 flex-wrap ml-8">
                      <span className={`px-2 py-1 rounded text-xs ${getPriorityColor(item.priority)}`}>
                        {item.priority}
                      </span>
                      {item.category && (
                        <span className="px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs">{item.category}</span>
                      )}
                      {item.price && (
                        <span className="text-yellow-500 font-bold text-sm">{item.price}</span>
                      )}
                      {item.plannedDate && (
                        <span className="text-blue-400 text-xs flex items-center gap-1">
                          <Calendar className="w-3 h-3" />
                          {item.plannedDate}
                        </span>
                      )}
                    </div>
                  </div>
                  <button onClick={() => removeShoppingItem(item.id)} className="p-2 hover:bg-red-900 rounded">
                    <Trash2 className="w-4 h-4 text-gray-400" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>

        {completedPurchases.length > 0 && (
          <div>
            <h3 className="text-white font-bold mb-3 flex items-center gap-2">
              <Check className="w-5 h-5 text-green-500" />
              –ö—É–ø–ª–µ–Ω–æ ({completedPurchases.length})
            </h3>
            <div className="space-y-2">
              {completedPurchases.map(item => (
                <div key={item.id} className="bg-gray-800 rounded-lg p-3 border border-green-900 opacity-75">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <Check className="w-4 h-4 text-green-500" />
                      <span className="text-gray-300 line-through">{item.item}</span>
                      {item.purchasedDate && (
                        <span className="text-xs text-gray-500">({item.purchasedDate})</span>
                      )}
                    </div>
                    <button onClick={() => removeShoppingItem(item.id)} className="p-1 hover:bg-red-900 rounded">
                      <Trash2 className="w-3 h-3 text-gray-500" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  const renderOutfits = () => {
    const filteredOutfits = outfitFilter === 'all' ? outfits : outfits.filter(o => o.season === outfitFilter);

    return (
      <div className="space-y-4">
        <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <h3 className="text-white font-medium mb-3">–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑</h3>
          <div className="space-y-3">
            <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞" value={newOutfit.name}
              onChange={(e) => setNewOutfit({...newOutfit, name: e.target.value})}
              className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            
            <div className="grid grid-cols-2 gap-2">
              <input type="text" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–†–∞–±–æ—Ç–∞, –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)" value={newOutfit.category}
                onChange={(e) => setNewOutfit({...newOutfit, category: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
              <select value={newOutfit.season} onChange={(e) => setNewOutfit({...newOutfit, season: e.target.value})}
                className="px-3 py-2 bg-gray-900 text-white rounded border border-gray-700">
                <option value="">–°–µ–∑–æ–Ω</option>
                <option value="–ª–µ—Ç–æ">–õ–µ—Ç–æ</option>
                <option value="–∑–∏–º–∞">–ó–∏–º–∞</option>
                <option value="–≤–µ—Å–Ω–∞">–í–µ—Å–Ω–∞</option>
                <option value="–æ—Å–µ–Ω—å">–û—Å–µ–Ω—å</option>
                <option value="–≤—Å–µ—Å–µ–∑–æ–Ω">–í—Å–µ—Å–µ–∑–æ–Ω</option>
              </select>
            </div>

            <textarea placeholder="–í–µ—â–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" value={newOutfit.items} rows="3"
              onChange={(e) => setNewOutfit({...newOutfit, items: e.target.value})}
              className="w-full px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />

            <button onClick={() => {
              if (newOutfit.name && newOutfit.items) {
                const items = newOutfit.items.split(',').map(i => i.trim()).filter(i => i);
                addOutfit({ ...newOutfit, items });
                setNewOutfit({ name: '', category: '', season: '', items: '' });
              }
            }}
              className="w-full px-4 py-2 bg-red-900 hover:bg-red-800 text-white rounded">
              –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑
            </button>
          </div>
        </div>

        <div className="flex gap-2 overflow-x-auto pb-2">
          {['all', '–ª–µ—Ç–æ', '–∑–∏–º–∞', '–≤–µ—Å–Ω–∞', '–æ—Å–µ–Ω—å', '–≤—Å–µ—Å–µ–∑–æ–Ω'].map(s => (
            <button key={s} onClick={() => setOutfitFilter(s)}
              className={`px-4 py-2 rounded-lg whitespace-nowrap transition ${
                outfitFilter === s ? 'bg-red-900 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
              }`}>
              {s === 'all' ? '–í—Å–µ' : s.charAt(0).toUpperCase() + s.slice(1)}
            </button>
          ))}
        </div>

        <div className="space-y-4">
          {filteredOutfits.map(outfit => {
            const check = checkOutfit(outfit);
            return (
              <div key={outfit.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div className="flex justify-between mb-3">
                  <div>
                    <h3 className="text-white font-medium mb-1">{outfit.name}</h3>
                    <div className="flex gap-2">
                      {outfit.category && (
                        <span className="px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs">{outfit.category}</span>
                      )}
                      {outfit.season && (
                        <span className="px-2 py-1 bg-blue-900 text-blue-200 rounded text-xs">{outfit.season}</span>
                      )}
                    </div>
                  </div>
                  <div className="flex gap-2">
                    {check.complete ? (
                      <span className="px-3 py-1 bg-green-900 text-green-100 rounded-full text-xs font-bold">
                        ‚úì –ì–æ—Ç–æ–≤
                      </span>
                    ) : (
                      <span className="px-3 py-1 bg-orange-900 text-orange-100 rounded-full text-xs font-bold">
                        –ù–µ –≥–æ—Ç–æ–≤
                      </span>
                    )}
                    <button onClick={() => deleteOutfit(outfit.id)} className="p-1 hover:bg-red-900 rounded">
                      <Trash2 className="w-4 h-4 text-gray-400" />
                    </button>
                  </div>
                </div>

                <div className="space-y-2">
                  <p className="text-gray-400 text-sm font-medium">–°–æ—Å—Ç–∞–≤:</p>
                  {outfit.items.map((item, idx) => {
                    const missing = check.missing.includes(item);
                    return (
                      <div key={idx} className="flex items-center gap-2">
                        <div className={`w-2 h-2 rounded-full ${missing ? 'bg-red-500' : 'bg-green-500'}`} />
                        <span className={`text-sm ${missing ? 'text-red-300' : 'text-gray-300'}`}>
                          {item}
                          {missing && ' (–Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å)'}
                        </span>
                      </div>
                    );
                  })}
                </div>

                {check.missing.length > 0 && (
                  <div className="mt-3 p-2 bg-red-900 bg-opacity-20 rounded border border-red-900">
                    <p className="text-red-300 text-sm">
                      –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: {check.missing.join(', ')}
                    </p>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  const renderInspiration = () => {
    return (
      <div className="space-y-4">
        <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <h3 className="text-white font-medium mb-3">–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</h3>
          <div className="flex gap-2">
            <input type="url" placeholder="https://..." value={newLink}
              onChange={(e) => setNewLink(e.target.value)}
              className="flex-1 px-3 py-2 bg-gray-900 text-white rounded border border-gray-700" />
            <button onClick={() => {
              if (newLink) {
                addLink(newLink);
                setNewLink('');
              }
            }}
              className="px-4 py-2 bg-red-900 hover:bg-red-800 text-white rounded">
              <Plus className="w-5 h-5" />
            </button>
          </div>
        </div>

        {inspirationLinks.map(link => (
          <div key={link.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div className="flex items-start justify-between">
              <a href={link.url} target="_blank" rel="noopener noreferrer"
                className="flex-1 text-red-400 hover:text-red-300 text-sm break-all">
                {link.url}
              </a>
              <button onClick={() => removeLink(link.id)} className="p-2 hover:bg-red-900 rounded ml-2">
                <Trash2 className="w-4 h-4 text-gray-400" />
              </button>
            </div>
          </div>
        ))}

        <div className="bg-gradient-to-r from-red-900 to-red-800 rounded-lg p-4">
          <h4 className="text-white font-bold mb-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
          <div className="space-y-2">
            <a href="https://lookastic.com/men/black-turtleneck/how-to-wear-with/blazer" 
               target="_blank" rel="noopener noreferrer"
               className="block text-red-100 hover:text-white text-sm underline">
              332 –æ–±—Ä–∞–∑–∞: –≤–æ–¥–æ–ª–∞–∑–∫–∞ + –ø–∏–¥–∂–∞–∫
            </a>
            <a href="https://lookastic.com/men/brown-suede-jacket/looks" 
               target="_blank" rel="noopener noreferrer"
               className="block text-red-100 hover:text-white text-sm underline">
              641 –æ–±—Ä–∞–∑: –∑–∞–º—à–µ–≤–∞—è –∫—É—Ä—Ç–∫–∞
            </a>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-900 text-white pb-20">
      <div className="bg-gradient-to-r from-red-900 to-red-800 p-6">
        <h1 className="text-2xl font-bold mb-2">–ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–± Pro</h1>
        <div className="flex items-center gap-2 text-xs text-red-100">
          <Save className="w-4 h-4" />
          <span>–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Ä¢ {stats.completion}% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</span>
        </div>
      </div>

      <div className="border-b border-gray-800 bg-gray-900 sticky top-0 z-10">
        <div className="flex overflow-x-auto">
          {[
            { id: 'wardrobe', name: '–ì–∞—Ä–¥–µ—Ä–æ–±', icon: Package },
            { id: 'shopping', name: '–®–æ–ø–∏–Ω–≥', icon: ShoppingBag },
            { id: 'outfits', name: '–û–±—Ä–∞–∑—ã', icon: Star },
            { id: 'inspiration', name: '–ò–¥–µ–∏', icon: Lightbulb }
          ].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)}
              className={`flex-1 min-w-fit px-6 py-4 text-sm font-medium transition ${
                activeTab === tab.id
                  ? 'text-red-500 border-b-2 border-red-500 bg-gray-800'
                  : 'text-gray-400 hover:text-gray-300'
              }`}>
              <tab.icon className="w-5 h-5 mx-auto mb-1" />
              {tab.name}
            </button>
          ))}
        </div>
      </div>

      <div className="p-4">
        {activeTab === 'wardrobe' && (showAnalytics ? renderAnalytics() : renderWardrobe())}
        {activeTab === 'shopping' && renderShoppingList()}
        {activeTab === 'outfits' && renderOutfits()}
        {activeTab === 'inspiration' && renderInspiration()}
      </div>
    </div>
  );
};

export default WardrobeApp;
