<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–± ‚Äî –í–µ–± –≤–µ—Ä—Å–∏—è</title>
  <style>
    :root{
      --bg:#0f1720; --panel:#111827; --muted:#9CA3AF; --accent:#dc2626; --accent-2:#f59e0b;
      --card:#111827; --card-border:rgba(255,255,255,0.04);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071226 0%,var(--bg) 100%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app{max-width:1100px;margin:24px auto;padding:16px;color:#fff;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:16px;}
    h1{margin:0;font-size:20px;color:#fff}
    .subtitle{color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;margin:12px 0;}
    .tab{padding:10px 14px;background:transparent;border:1px solid transparent;border-radius:10px;color:var(--muted);cursor:pointer}
    .tab.active{background:rgba(255,255,255,0.03);border-color:var(--card-border);color:#fff}
    .grid{display:grid;gap:12px}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .panel{background:var(--panel);border:1px solid var(--card-border);padding:12px;border-radius:10px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="date"], select, textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0b1220;color:#fff}
    textarea{min-height:68px;resize:vertical}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .list-item{display:flex;gap:12px;align-items:flex-start;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .item-photo{width:64px;height:64px;object-fit:cover;border-radius:6px;background:#0b1220;border:1px solid rgba(255,255,255,0.03)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-size:12px}
    .badge-green{background:#064e3b;color:#bbf7d0;padding:4px 8px;border-radius:999px;font-size:12px}
    .badge-red{background:#7f1d1d;color:#ffd7d7;padding:4px 8px;border-radius:999px;font-size:12px}
    .priority-pill{padding:4px 8px;border-radius:999px;font-size:12px}
    .prio-critical{background:#7f1d1d;color:#fff}
    .prio-high{background:#9a3412;color:#fff}
    .prio-mid{background:#713f12;color:#fff}
    .prio-low{background:#374151;color:#fff}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .ml-auto{margin-left:auto}
    .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#10b981,#06b6d4)}
    .kpi{font-size:20px;font-weight:700}
    .chart-row{display:flex;gap:8px;flex-wrap:wrap}
    .card{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    .telegram-btn{display:inline-flex;gap:8px;align-items:center;background:#0088cc;padding:8px 12px;border-radius:8px;color:#fff;text-decoration:none}
    .analytics-toggle{font-size:16px;padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
    code{background:rgba(255,255,255,0.02);padding:2px 4px;border-radius:4px;color:#e6eef6}
    .flex-col{display:flex;flex-direction:column}
    /* responsive */
    @media (max-width:900px){.cols-3{grid-template-columns:repeat(1,1fr)}.cols-2{grid-template-columns:repeat(1,1fr)}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>–ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–± ‚Äî Web</h1>
        <div class="subtitle">–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã + –∞–Ω–∞–ª–∏—Ç–∏–∫–∞. –ú–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ GitHub Pages.</div>
      </div>
      <div class="ml-auto flex" style="align-self:center">
        <!-- Replace BOT_USERNAME below -->
        <a id="tgOpen" class="telegram-btn" href="#" target="_blank" rel="noopener noreferrer">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</a>
      </div>
    </header>

    <div class="tabs" id="mainTabs">
      <button class="tab active" data-tab="wardrobe">–ì–∞—Ä–¥–µ—Ä–æ–±</button>
      <button class="tab" data-tab="shopping">–®–æ–ø–∏–Ω–≥</button>
      <button class="tab" data-tab="outfits">–û–±—Ä–∞–∑—ã</button>
      <button class="tab" data-tab="inspiration">–ò–¥–µ–∏</button>
      <button class="tab" data-tab="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <main id="root">
      <!-- Wardrobe view -->
      <section id="wardrobe" class="panel">
        <div class="flex" style="align-items:flex-start">
          <div style="flex:1">
            <div class="flex" style="gap:8px;margin-bottom:8px">
              <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–≥–∞–º" />
              <select id="filterStatus">
                <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="owned">–¢–æ–ª—å–∫–æ –µ—Å—Ç—å</option>
                <option value="needed">–¢–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ</option>
              </select>
              <select id="filterPriority">
                <option value="all">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
              </select>

              <button id="toggleView" class="analytics-toggle">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>

              <div class="ml-auto flex">
                <button id="exportWardrobeBtn" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button id="clearAllBtn" class="btn ghost">–°–±—Ä–æ—Å</button>
              </div>
            </div>

            <div class="panel" style="margin-bottom:12px">
              <div style="display:flex;gap:12px;align-items:center">
                <h3 style="margin:0">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å</h3>
                <div class="muted" style="font-size:13px">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ –î–æ–±–∞–≤–∏—Ç—å</div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 120px 120px;gap:8px;margin-top:8px">
                <input id="newName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä: –ö–æ—Å—Ç—é–º —á–µ—Ä–Ω—ã–π)" />
                <select id="newCategory">
                  <option value="suits">–ö–æ—Å—Ç—é–º—ã</option>
                  <option value="shirts">–†—É–±–∞—à–∫–∏</option>
                  <option value="knitwear">–¢—Ä–∏–∫–æ—Ç–∞–∂</option>
                  <option value="polo">–ü–æ–ª–æ</option>
                  <option value="pants">–ë—Ä—é–∫–∏</option>
                  <option value="shoes">–û–±—É–≤—å</option>
                  <option value="accessories">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
                </select>
                <select id="newStatus">
                  <option value="–µ—Å—Ç—å">–ï—Å—Ç—å</option>
                  <option value="–Ω—É–∂–µ–Ω">–ù—É–∂–µ–Ω</option>
                </select>
                <input id="newTags" type="text" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" style="grid-column:1/span2" />
                <select id="newPriority" style="grid-column:3">
                  <option value="–Ω–∏–∑–∫–∏–π">–ù–∏–∑–∫–∏–π</option>
                  <option value="—Å—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="–≤—ã—Å–æ–∫–∏–π">–í—ã—Å–æ–∫–∏–π</option>
                  <option value="–∫—Ä–∏—Ç–∏—á–Ω—ã–π">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                </select>
                <input id="newNotes" type="text" placeholder="–ó–∞–º–µ—Ç–∫–∏" style="grid-column:1/span3" />
                <input id="newPhoto" type="file" accept="image/*" style="grid-column:1/span2" />
                <button id="addItemBtn" class="btn primary" style="grid-column:3">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div id="itemsList" class="grid" style="margin-top:12px"></div>

          </div>

          <!-- Right column: stats & categories -->
          <aside style="width:320px">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="small muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                  <div class="kpi" id="kpiTotal">‚Äî</div>
                </div>
                <div style="text-align:right">
                  <div class="small muted">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
                  <div id="kpiCompletion" class="kpi">‚Äî</div>
                </div>
              </div>
              <div style="margin-top:10px">
                <div class="small muted">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                <div id="categoryStats" style="margin-top:8px"></div>
              </div>
            </div>

            <div class="panel" style="margin-top:12px">
              <div class="small muted">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏</div>
              <div id="topTags" style="margin-top:8px"></div>
            </div>

            <div class="panel" style="margin-top:12px">
              <div class="small muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</div>
              <div id="priorityStats" style="margin-top:8px"></div>
            </div>

          </aside>
        </div>
      </section>

      <!-- Shopping -->
      <section id="shopping" class="panel" style="display:none">
        <div class="flex" style="align-items:center;gap:8px">
          <input id="shopName" type="text" placeholder="–ß—Ç–æ –∫—É–ø–∏—Ç—å (–Ω–∞–ø—Ä. –¢—É—Ñ–ª–∏ —á–µ—Ä–Ω—ã–µ)" />
          <select id="shopPriority">
            <option>–ö–†–ò–¢–ò–ß–ù–û</option>
            <option>–í–´–°–û–ö–ò–ô</option>
            <option selected>–°–†–ï–î–ù–ò–ô</option>
            <option>–ù–ò–ó–ö–ò–ô</option>
          </select>
          <input id="shopPrice" type="text" placeholder="–¶–µ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: ‚Ç¨200-300)" />
          <button id="addShopBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button id="exportShoppingBtn" class="btn ghost ml-auto">–≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>

        <div style="margin-top:12px">
          <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏</h3>
          <div id="activePurchases" style="margin-top:8px"></div>

          <h3 style="margin-top:12px">–ö—É–ø–ª–µ–Ω–æ</h3>
          <div id="completedPurchases" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Outfits -->
      <section id="outfits" class="panel" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 160px;gap:8px">
          <div>
            <input id="outfitName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞" />
            <input id="outfitCategory" type="text" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–†–∞–±–æ—Ç–∞, –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏)" />
            <select id="outfitSeason">
              <option value="">–°–µ–∑–æ–Ω</option>
              <option value="–ª–µ—Ç–æ">–õ–µ—Ç–æ</option>
              <option value="–∑–∏–º–∞">–ó–∏–º–∞</option>
              <option value="–≤–µ—Å–Ω–∞">–í–µ—Å–Ω–∞</option>
              <option value="–æ—Å–µ–Ω—å">–û—Å–µ–Ω—å</option>
              <option value="–≤—Å–µ—Å–µ–∑–æ–Ω">–í—Å–µ—Å–µ–∑–æ–Ω</option>
            </select>
            <input id="outfitItems" type="text" placeholder="–í–µ—â–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" />
            <button id="addOutfitBtn" class="btn primary" style="margin-top:8px">–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–∑</button>
          </div>
          <div>
            <div class="small muted">–§–∏–ª—å—Ç—Ä –ø–æ —Å–µ–∑–æ–Ω—É</div>
            <select id="outfitFilter">
              <option value="all">–í—Å–µ</option>
              <option value="–ª–µ—Ç–æ">–õ–µ—Ç–æ</option>
              <option value="–∑–∏–º–∞">–ó–∏–º–∞</option>
              <option value="–≤–µ—Å–Ω–∞">–í–µ—Å–Ω–∞</option>
              <option value="–æ—Å–µ–Ω—å">–û—Å–µ–Ω—å</option>
              <option value="–≤—Å–µ—Å–µ–∑–æ–Ω">–í—Å–µ—Å–µ–∑–æ–Ω</option>
            </select>
            <div style="margin-top:12px">
              <h4>–°–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤</h4>
              <div id="outfitsList"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Inspiration -->
      <section id="inspiration" class="panel" style="display:none">
        <div style="display:flex;gap:8px">
          <input id="newLink" type="url" placeholder="https://..." />
          <button id="addLinkBtn" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button id="openRecommendations" class="btn ghost ml-auto">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
        </div>
        <div id="linksList" style="margin-top:12px"></div>

        <div style="margin-top:12px" class="panel">
          <h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
          <ul>
            <li><a target="_blank" rel="noopener noreferrer" href="https://lookastic.com/men/black-turtleneck/how-to-wear-with/blazer">332 –æ–±—Ä–∞–∑–∞: –≤–æ–¥–æ–ª–∞–∑–∫–∞ + –ø–∏–¥–∂–∞–∫</a></li>
            <li><a target="_blank" rel="noopener noreferrer" href="https://lookastic.com/men/brown-suede-jacket/looks">641 –æ–±—Ä–∞–∑: –∑–∞–º—à–µ–≤–∞—è –∫—É—Ä—Ç–∫–∞</a></li>
          </ul>
        </div>
      </section>

      <!-- Analytics -->
      <section id="analytics" class="panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
          <div>
            <button id="downloadReport" class="btn primary">–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</button>
            <button id="closeAnalytics" class="btn ghost">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
          </div>
        </div>

        <div style="margin-top:12px" class="grid cols-3">
          <div class="card">
            <div class="small muted">–í—Å–µ–≥–æ –≤–µ—â–µ–π</div>
            <div class="kpi" id="aTotal">‚Äî</div>
            <div class="small muted">–ï—Å—Ç—å</div>
            <div id="aOwned" class="kpi">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å</div>
            <div class="kpi" id="aNeeded">‚Äî</div>
            <div class="small muted">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div>
            <div id="aCritical" class="kpi">‚Äî</div>
          </div>
          <div class="card">
            <div class="small muted">–ë—é–¥–∂–µ—Ç –≤ —à–æ–ø–∏–Ω–≥-–ª–∏—Å—Ç–µ</div>
            <div class="kpi" id="aBudget">‚Äî</div>
            <div class="small muted">–°–æ–±—ã—Ç–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>
            <div id="aEvents" class="kpi">‚Äî</div>
          </div>
        </div>

        <div style="margin-top:12px" class="grid cols-2">
          <div class="card">
            <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
            <div id="aCatStats"></div>
          </div>
          <div class="card">
            <h4>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–≥–∏</h4>
            <div id="aTags"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="grid cols-2">
          <div class="card">
            <h4>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</h4>
            <div id="aPriority"></div>
          </div>
          <div class="card">
            <h4>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h4>
            <div id="aHistory"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="panel">
          <h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
          <div id="aRecs"></div>
        </div>

      </section>

    </main>

    <footer>
      –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ index.html –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub Pages. –ü–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π –∑–∞–º–µ–Ω–∏—Ç–µ —Å—Å—ã–ª–∫—É Telegram –≤ —à–∞–ø–∫–µ –Ω–∞ –≤–∞—à –±–æ—Ç.
    </footer>
  </div>

<script>
/*
  Simple wardrobe SPA ‚Äî single HTML file.
  - Uses localStorage for persistence
  - Features: wardrobe, shopping, outfits, inspiration, analytics, export
  - To enable Telegram link: set BOT_USERNAME variable below
*/

// ---------- Configuration ----------
const BOT_USERNAME = 'YOUR_BOT_USERNAME'; // <-- –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –±–µ–∑ @
const STORAGE_KEYS = {
  wardrobe: 'wardrobe-data-v2',
  shopping: 'shopping-data-v2',
  outfits: 'outfits-data-v2',
  links: 'inspiration-data-v2',
  analytics: 'wardrobe-analytics-v1'
};

// Set Telegram open link
const tgOpen = document.getElementById('tgOpen');
if (BOT_USERNAME && BOT_USERNAME !== 'YOUR_BOT_USERNAME') {
  tgOpen.href = `https://t.me/${BOT_USERNAME}`;
  tgOpen.textContent = '–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram';
} else {
  tgOpen.href = '#';
  tgOpen.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram (—É–∫–∞–∂–∏—Ç–µ BOT_USERNAME –≤ index.html)';
}

// ---------- Safe storage helpers ----------
function safeParse(s){ try { return JSON.parse(s); } catch(e){ return null; } }
async function storageGet(key){ try { const v = localStorage.getItem(key); return v? safeParse(v): null; } catch(e){ console.warn('storageGet',e); return null; } }
async function storageSet(key, data){ try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){ console.warn('storageSet',e); } }
async function storageInit(){
  const defWardrobe = {
    suits:[{id:1,name:'–ö–æ—Å—Ç—é–º —á–µ—Ä–Ω—ã–π –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π',status:'–µ—Å—Ç—å',priority:'–≤—ã—Å–æ–∫–∏–π',tags:'–æ—Ñ–∏—Å,—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π',notes:''},
           {id:5,name:'–ö–æ—Å—Ç—é–º —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π',status:'–Ω—É–∂–µ–Ω',priority:'–∫—Ä–∏—Ç–∏—á–Ω—ã–π',tags:'—Å—É–¥–µ–π—Å—Ç–≤–æ',notes:''}],
    shirts:[{id:6,name:'–†—É–±–∞—à–∫–∏ –±–µ–ª—ã–µ',count:2,status:'–µ—Å—Ç—å',priority:'—Å—Ä–µ–¥–Ω–∏–π',tags:'–±–∞–∑–æ–≤—ã–π',notes:''}],
    knitwear:[],polo:[],pants:[],shoes:[],accessories:[]
  };
  if(!await storageGet(STORAGE_KEYS.wardrobe)) await storageSet(STORAGE_KEYS.wardrobe, defWardrobe);
  if(!await storageGet(STORAGE_KEYS.shopping)) await storageSet(STORAGE_KEYS.shopping, []);
  if(!await storageGet(STORAGE_KEYS.outfits)) await storageSet(STORAGE_KEYS.outfits, []);
  if(!await storageGet(STORAGE_KEYS.links)) await storageSet(STORAGE_KEYS.links, []);
  if(!await storageGet(STORAGE_KEYS.analytics)) await storageSet(STORAGE_KEYS.analytics, []);
}

// ---------- Utilities ----------
function uid(){ return Date.now() + Math.floor(Math.random()*1000); }
function flattenWardrobe(w){ return Object.values(w).flat(); }
function formatDate(d){ if(!d) return ''; const dt = new Date(d); if(isNaN(dt)) return d; return dt.toISOString().split('T')[0]; }

// ---------- Core actions (CRUD + analytics tracking) ----------
async function addItem(item){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  w[item.category] = w[item.category] || [];
  w[item.category].push(item);
  await storageSet(STORAGE_KEYS.wardrobe, w);
  trackEvent('add_item',{category:item.category,name:item.name,priority:item.priority,status:item.status});
  renderAll();
}
async function deleteItem(category,id){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  w[category] = (w[category]||[]).filter(i=>i.id!==id);
  await storageSet(STORAGE_KEYS.wardrobe, w);
  trackEvent('delete_item',{category,id});
  renderAll();
}
async function updateItem(category,id,updates){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  w[category] = (w[category]||[]).map(i=> i.id===id? {...i,...updates}:i);
  await storageSet(STORAGE_KEYS.wardrobe, w);
  trackEvent('update_item',{category,id,updates});
  renderAll();
}

async function addShopping(obj){
  const list = await storageGet(STORAGE_KEYS.shopping) || [];
  list.push(obj);
  await storageSet(STORAGE_KEYS.shopping,list);
  trackEvent('add_shopping',{item:obj.item,price:obj.price,priority:obj.priority});
  renderAll();
}
async function togglePurchased(id){
  const list = await storageGet(STORAGE_KEYS.shopping) || [];
  const newList = list.map(i => i.id===id ? {...i, purchased: !i.purchased, purchasedDate: !i.purchased? formatDate(new Date()): null} : i);
  await storageSet(STORAGE_KEYS.shopping,newList);
  trackEvent('toggle_purchased',{id});
  renderAll();
}
async function removeShopping(id){
  const list = await storageGet(STORAGE_KEYS.shopping) || [];
  const item = list.find(i=>i.id===id);
  const newList = list.filter(i=>i.id!==id);
  await storageSet(STORAGE_KEYS.shopping,newList);
  trackEvent('remove_shopping',{id,item:item?.item});
  renderAll();
}

async function addOutfit(obj){
  const list = await storageGet(STORAGE_KEYS.outfits) || [];
  list.push(obj);
  await storageSet(STORAGE_KEYS.outfits,list);
  trackEvent('add_outfit',{name:obj.name,items:obj.items});
  renderAll();
}
async function deleteOutfit(id){
  const list = await storageGet(STORAGE_KEYS.outfits) || [];
  const o = list.find(x=>x.id===id);
  const newList = list.filter(i=>i.id!==id);
  await storageSet(STORAGE_KEYS.outfits,newList);
  trackEvent('delete_outfit',{id,name:o?.name});
  renderAll();
}

async function addLink(url){
  const list = await storageGet(STORAGE_KEYS.links) || [];
  list.push({id:uid(),url});
  await storageSet(STORAGE_KEYS.links,list);
  trackEvent('add_link',{url});
  renderAll();
}
async function removeLink(id){
  const list = await storageGet(STORAGE_KEYS.links) || [];
  const newList = list.filter(l=>l.id!==id);
  await storageSet(STORAGE_KEYS.links,newList);
  trackEvent('remove_link',{id});
  renderAll();
}

async function trackEvent(type,payload={}){
  const e = {id:uid(),type,payload,ts:(new Date()).toISOString()};
  const arr = await storageGet(STORAGE_KEYS.analytics) || [];
  arr.push(e);
  await storageSet(STORAGE_KEYS.analytics,arr);
}

// ---------- Reports & analytics computations ----------
async function computeStats(){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  const sList = await storageGet(STORAGE_KEYS.shopping) || [];
  const all = flattenWardrobe(w);
  const total = all.length;
  const owned = all.filter(i=>i.status==='–µ—Å—Ç—å').length;
  const needed = total - owned;
  const critical = all.filter(i=> (i.priority||'').toString().toLowerCase().includes('–∫—Ä–∏—Ç')).length;
  const completion = total>0? Math.round((owned/total)*100):0;
  const shoppingTotal = sList.reduce((sum,i)=>{
    const m = (i.price||'').toString().match(/‚Ç¨(\d+)/);
    return sum + (m? parseInt(m[1]):0);
  },0);
  return {total,owned,needed,critical,completion,shoppingTotal};
}
async function computeCategoryStats(){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  return Object.entries(w).map(([cat,items])=>{
    const total = items.length;
    const owned = items.filter(i=>i.status==='–µ—Å—Ç—å').length;
    const needed = total - owned;
    const percent = total>0? Math.round((owned/total)*100):0;
    return {category:cat,total,owned,needed,percent};
  });
}
async function getTopTags(topN=10){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  const all = flattenWardrobe(w);
  const map = {};
  all.forEach(i=>{
    (i.tags||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean).forEach(t=> map[t]=(map[t]||0)+1);
  });
  return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,topN).map(([tag,count])=>({tag,count}));
}
async function getPriorityStats(){
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  const all = flattenWardrobe(w);
  const map = {};
  all.forEach(i=>{ const p=(i.priority||'–Ω–∏–∑–∫–∏–π').toString(); map[p]=(map[p]||0)+1; });
  return Object.entries(map).map(([priority,count])=>({priority,count}));
}
async function getPurchaseHistoryLast(n=10){
  const s = await storageGet(STORAGE_KEYS.shopping) || [];
  const purchased = s.filter(i=>i.purchased).slice().sort((a,b)=>(b.purchasedDate||b.id).localeCompare(a.purchasedDate||a.id));
  return purchased.slice(0,n);
}
async function getPurchasesByMonth(){
  const s = await storageGet(STORAGE_KEYS.shopping) || [];
  const purchased = s.filter(i=>i.purchased && i.purchasedDate);
  const map = {};
  purchased.forEach(p=>{
    const d = new Date(p.purchasedDate);
    if(isNaN(d)) return;
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    map[key] = map[key] || [];
    map[key].push(p);
  });
  return Object.entries(map).sort((a,b)=>b[0].localeCompare(a[0])).map(([month,items])=>({month,items}));
}
async function getRecommendations(){
  const cat = await computeCategoryStats();
  const missingCats = cat.filter(c=>c.owned===0).map(c=>c.category);
  const s = await storageGet(STORAGE_KEYS.shopping) || [];
  const criticals = s.filter(i=> (i.priority||'').toString().toLowerCase().includes('–∫—Ä–∏—Ç')).map(i=> `${i.item} ${i.price||''}`);
  const outfits = await storageGet(STORAGE_KEYS.outfits) || [];
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  const all = flattenWardrobe(w);
  const incomplete = outfits.map(o=>{
    const missing = o.items.filter(oi => !all.some(wi => wi.name.toLowerCase().includes(oi.toLowerCase()) && wi.status==='–µ—Å—Ç—å'));
    return {...o,missing};
  }).filter(o=>o.missing.length>0);
  return {
    basics: missingCats,
    criticals,
    incomplete
  };
}

// ---------- Export full report ----------
async function exportFullReport(){
  const s = await computeStats();
  const cat = await computeCategoryStats();
  const tags = await getTopTags(50);
  const pr = await getPriorityStats();
  const purchases = await getPurchaseHistoryLast(50);
  const purchasesBy = await getPurchasesByMonth();
  const rec = await getRecommendations();

  let txt = `–û—Ç—á—ë—Ç: –ú–æ–π –≥–∞—Ä–¥–µ—Ä–æ–±\n–î–∞—Ç–∞: ${new Date().toISOString()}\n\n`;
  txt += `–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:\n–í—Å–µ–≥–æ –≤–µ—â–µ–π: ${s.total}\n–ï—Å—Ç—å: ${s.owned}\n–ù—É–∂–Ω–æ: ${s.needed}\n–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö: ${s.critical}\n–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${s.completion}%\n–ë—é–¥–∂–µ—Ç (–ø—Ä–∏–±–ª): ‚Ç¨${s.shoppingTotal}+\n\n`;
  txt += `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n`;
  cat.forEach(c=> txt+= `- ${c.category}: ${c.owned}/${c.total} (${c.percent}%)\n`);
  txt += `\n–¢–æ–ø —Ç–µ–≥–æ–≤:\n`; tags.forEach(t=> txt+= `- ${t.tag}: ${t.count}\n`);
  txt += `\n–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:\n`; pr.forEach(p=> txt+= `- ${p.priority}: ${p.count}\n`);
  txt += `\n–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${purchases.length}):\n`; purchases.forEach(p=> txt+= `- ${p.item} ${p.price||''} –∫—É–ø–ª–µ–Ω–æ: ${p.purchasedDate||''}\n`);
  txt += `\n–ü–æ–∫—É–ø–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º:\n`; purchasesBy.forEach(m=>{ txt+= `\n${m.month}:\n`; m.items.forEach(it=> txt+= `  - ${it.item} (${it.purchasedDate})\n`); });
  txt += `\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n`; txt += `- –ë–∞–∑–æ–≤—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤: ${rec.basics.length? rec.basics.join(', '): '–ù–µ—Ç'}\n`; txt += `- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏: ${rec.criticals.length? rec.criticals.join('; '): '–ù–µ—Ç'}\n`;
  txt += `- –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã: ${rec.incomplete.length? rec.incomplete.map(i=> `${i.name}: ${i.missing.join(', ')}`).join('; '): '–ù–µ—Ç'}\n`;

  const blob = new Blob([txt],{type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'wardrobe-full-report.txt'; a.click();
  URL.revokeObjectURL(url);
  trackEvent('export_full_report',{total:s.total,shoppingTotal:s.shoppingTotal});
}

// ---------- Rendering ----------
async function renderAll(){
  await renderWardrobeList();
  await renderKPIs();
  await renderSideStats();
  await renderShopping();
  await renderOutfits();
  await renderLinks();
  await renderAnalyticsView();
}

async function renderWardrobeList(){
  const container = document.getElementById('itemsList');
  container.innerHTML = '';
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  const selectedCategory = document.getElementById('newCategory').value;
  const search = (document.getElementById('search').value||'').toLowerCase();
  const statusFilter = document.getElementById('filterStatus').value;
  const prFilter = document.getElementById('filterPriority').value;

  let items = Object.entries(w).flatMap(([cat,its]) => its.map(i => ({...i,category:cat})));
  if(search){ items = items.filter(i=> i.name.toLowerCase().includes(search) || (i.tags||'').toLowerCase().includes(search)); }
  if(statusFilter==='owned') items = items.filter(i=> i.status==='–µ—Å—Ç—å');
  if(statusFilter==='needed') items = items.filter(i=> i.status!=='–µ—Å—Ç—å');
  if(prFilter!=='all') items = items.filter(i=> i.priority === prFilter);

  if(items.length===0){ container.innerHTML = '<div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }

  items.forEach(item=>{
    const div = document.createElement('div'); div.className='list-item';
    const img = document.createElement('img'); img.className='item-photo';
    img.src = item.photo || '';
    img.alt = item.name;
    if(!item.photo){ img.style.background = '#071218'; img.style.display='inline-block' }
    const info = document.createElement('div'); info.style.flex='1';
    const title = document.createElement('div'); title.innerHTML=`<strong>${item.name}</strong> <span class="muted">(${item.category})</span>`;
    const meta = document.createElement('div'); meta.className='small muted';
    const statusBadge = item.status && (item.status!=='–µ—Å—Ç—å'? `<span class="badge-red">–ù—É–∂–Ω–æ</span>`:`<span class="badge-green">–ï—Å—Ç—å</span>`);
    const prClass = item.priority==='–∫—Ä–∏—Ç–∏—á–Ω—ã–π'?'prio-critical': item.priority==='–≤—ã—Å–æ–∫–∏–π'?'prio-high':item.priority==='—Å—Ä–µ–¥–Ω–∏–π'?'prio-mid':'prio-low';
    const priority = `<span class="priority-pill ${prClass}">${item.priority}</span>`;
    const tags = item.tags? `<div style="margin-top:6px"><span class="tag">#${(item.tags||'').split(',')[0]}</span></div>` : '';
    meta.innerHTML = `${statusBadge} ${priority} ${item.count? ' ‚Äî ' + item.count + ' —à—Ç':''} ${tags}`;
    const notes = document.createElement('div'); notes.className='muted small'; notes.textContent = item.notes || '';
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const editBtn = document.createElement('button'); editBtn.className='btn ghost small'; editBtn.textContent='–ò–∑–º–µ–Ω–∏—Ç—å';
    editBtn.onclick = ()=> openEditModal(item);
    const delBtn = document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='–£–¥–∞–ª–∏—Ç—å';
    delBtn.onclick = ()=> { if(confirm('–£–¥–∞–ª–∏—Ç—å –≤–µ—â—å?')) deleteItem(item.category,item.id); };
    actions.appendChild(editBtn); actions.appendChild(delBtn);

    info.appendChild(title); info.appendChild(meta); info.appendChild(notes); info.appendChild(actions);
    div.appendChild(img); div.appendChild(info);
    container.appendChild(div);
  });
}

function openEditModal(item){
  // simple inline prompt editing (keeps UI minimal)
  const newName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', item.name);
  if(newName===null) return;
  const newStatus = prompt('–°—Ç–∞—Ç—É—Å (–µ—Å—Ç—å/–Ω—É–∂–µ–Ω)', item.status) || item.status;
  const newPriority = prompt('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–∏–∑–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π/–∫—Ä–∏—Ç–∏—á–Ω—ã–π)', item.priority) || item.priority;
  const newTags = prompt('–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)', item.tags||'') ;
  const newNotes = prompt('–ó–∞–º–µ—Ç–∫–∏', item.notes||'') ;
  updateItem(item.category, item.id, {name:newName, status:newStatus, priority:newPriority, tags:newTags, notes:newNotes});
}

async function renderKPIs(){
  const s = await computeStats();
  document.getElementById('kpiTotal').textContent = `${s.total} –≤–µ—â–µ–π`;
  document.getElementById('kpiCompletion').textContent = `${s.completion}%`;
}

async function renderSideStats(){
  const cat = await computeCategoryStats();
  const container = document.getElementById('categoryStats'); container.innerHTML='';
  cat.forEach(c=>{
    const row = document.createElement('div'); row.style.marginBottom='8px';
    row.innerHTML = `<div style="display:flex;justify-content:space-between"><div class="small">${c.category}</div><div class="small">${c.owned}/${c.total}</div></div>
      <div class="progress" style="margin-top:6px"><i style="width:${c.percent}%"></i></div>`;
    container.appendChild(row);
  });

  const tags = await getTopTags(10);
  const tcont = document.getElementById('topTags'); tcont.innerHTML='';
  if(tags.length===0) tcont.innerHTML='<div class="muted">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>';
  tags.forEach(t=>{
    const el = document.createElement('div'); el.className='small muted'; el.textContent = `#${t.tag} ‚Äî ${t.count}`;
    tcont.appendChild(el);
  });

  const pr = await getPriorityStats();
  const pcont = document.getElementById('priorityStats'); pcont.innerHTML='';
  pr.forEach(p=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between';
    el.innerHTML = `<div class="small">${p.priority}</div><div class="kpi small" style="font-weight:600">${p.count}</div>`;
    pcont.appendChild(el);
  });
}

async function renderShopping(){
  const s = await storageGet(STORAGE_KEYS.shopping) || [];
  const active = s.filter(i=>!i.purchased);
  const completed = s.filter(i=>i.purchased);
  const actCont = document.getElementById('activePurchases'); actCont.innerHTML = '';
  active.forEach(i=>{
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div style="flex:1"><div><strong>${i.item}</strong> <span class="muted small">${i.priority} ${i.price? '‚Äî ' + i.price: ''}</span></div></div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const tog = document.createElement('button'); tog.className='btn ghost small'; tog.textContent='–ö—É–ø–ª–µ–Ω–æ'; tog.onclick = ()=> togglePurchased(i.id);
    const rem = document.createElement('button'); rem.className='btn ghost small'; rem.textContent='–£–¥–∞–ª–∏—Ç—å'; rem.onclick = ()=> removeShopping(i.id);
    actions.appendChild(tog); actions.appendChild(rem);
    div.appendChild(actions);
    actCont.appendChild(div);
  });
  const compCont = document.getElementById('completedPurchases'); compCont.innerHTML = '';
  completed.forEach(i=>{
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div style="flex:1"><div><strong style="text-decoration:line-through">${i.item}</strong> <span class="muted small">${i.purchasedDate||''}</span></div></div>`;
    const rem = document.createElement('button'); rem.className='btn ghost small'; rem.textContent='–£–¥–∞–ª–∏—Ç—å'; rem.onclick = ()=> removeShopping(i.id);
    div.appendChild(rem);
    compCont.appendChild(div);
  });
}

async function renderOutfits(){
  const list = await storageGet(STORAGE_KEYS.outfits) || [];
  const filter = document.getElementById('outfitFilter').value;
  const cont = document.getElementById('outfitsList'); cont.innerHTML='';
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  const all = flattenWardrobe(w);
  (filter==='all'? list: list.filter(o=>o.season===filter)).forEach(o=>{
    const check = o.items.map(item=> ({item,have: all.some(wi=> wi.name.toLowerCase().includes(item.toLowerCase()) && wi.status==='–µ—Å—Ç—å')}));
    const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${o.name}</strong> <span class="muted small">${o.category||''}</span></div><div><button class="btn ghost small">–£–¥–∞–ª–∏—Ç—å</button></div></div>`;
    const listEl = document.createElement('div'); listEl.style.marginTop='8px';
    check.forEach(c=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between';
      row.innerHTML = `<div class="small">${c.item}</div><div class="small ${c.have? '':'muted'}">${c.have? '–ï—Å—Ç—å':'–ù—É–∂–Ω–æ'}</div>`;
      listEl.appendChild(row);
    });
    div.appendChild(listEl);
    const delBtn = div.querySelector('button'); delBtn.onclick = ()=> { if(confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑?')) deleteOutfit(o.id); };
    cont.appendChild(div);
  });
}

async function renderLinks(){
  const list = await storageGet(STORAGE_KEYS.links) || [];
  const cont = document.getElementById('linksList'); cont.innerHTML='';
  list.forEach(l=>{
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `<div style="flex:1"><a href="${l.url}" target="_blank" rel="noopener noreferrer" class="small">${l.url}</a></div>`;
    const del = document.createElement('button'); del.className='btn ghost small'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.onclick=()=> removeLink(l.id);
    div.appendChild(del);
    cont.appendChild(div);
  });
}

async function renderAnalyticsView(){
  const s = await computeStats();
  document.getElementById('aTotal').textContent = `${s.total}`;
  document.getElementById('aOwned').textContent = `${s.owned}`;
  document.getElementById('aNeeded').textContent = `${s.needed}`;
  document.getElementById('aCritical').textContent = `${s.critical}`;
  document.getElementById('aBudget').textContent = `‚Ç¨${s.shoppingTotal}+`;
  const events = await storageGet(STORAGE_KEYS.analytics) || [];
  document.getElementById('aEvents').textContent = `${events.length}`;

  const cat = await computeCategoryStats();
  const catCont = document.getElementById('aCatStats'); catCont.innerHTML='';
  cat.forEach(c=>{
    const r = document.createElement('div'); r.style.marginBottom='8px';
    r.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${c.category}</div><div>${c.owned}/${c.total} (${c.percent}%)</div></div><div class="progress" style="margin-top:6px"><i style="width:${c.percent}%"></i></div>`;
    catCont.appendChild(r);
  });

  const tags = await getTopTags(10);
  const tagsCont = document.getElementById('aTags'); tagsCont.innerHTML='';
  if(tags.length===0) tagsCont.innerHTML='<div class="muted">–ù–µ—Ç —Ç–µ–≥–æ–≤</div>';
  tags.forEach(t=>{ const el = document.createElement('div'); el.className='small muted'; el.textContent = `#${t.tag} ‚Äî ${t.count}`; tagsCont.appendChild(el); });

  const pr = await getPriorityStats();
  const prCont = document.getElementById('aPriority'); prCont.innerHTML='';
  pr.forEach(p=>{ const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.innerHTML=`<div class="small">${p.priority}</div><div class="kpi small">${p.count}</div>`; prCont.appendChild(el); });

  const history = await getPurchaseHistoryLast(10);
  const hCont = document.getElementById('aHistory'); hCont.innerHTML='';
  if(history.length===0) hCont.innerHTML='<div class="muted">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫</div>';
  history.forEach(h=> { const el=document.createElement('div'); el.className='small muted'; el.textContent = `${h.item} ‚Äî ${h.purchasedDate||''}`; hCont.appendChild(el); });

  const rec = await getRecommendations();
  const recCont = document.getElementById('aRecs'); recCont.innerHTML='';
  const basics = document.createElement('div'); basics.className='small muted'; basics.textContent = `–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö: ${rec.basics.length? rec.basics.join(', '): '–û–∫'}`;
  const crit = document.createElement('div'); crit.className='small muted'; crit.textContent = `–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏: ${rec.criticals.length? rec.criticals.join('; '): '–ù–µ—Ç'}`;
  const inc = document.createElement('div'); inc.className='small muted'; inc.textContent = `–ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã: ${rec.incomplete.length? rec.incomplete.map(i=> `${i.name}: ${i.missing.join(', ')}`).join('; '): '–ù–µ—Ç'}`;
  recCont.appendChild(basics); recCont.appendChild(crit); recCont.appendChild(inc);
}

// ---------- Event bindings ----------
document.getElementById('addItemBtn').addEventListener('click', async ()=>{
  const name = (document.getElementById('newName').value||'').trim();
  if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
  const category = document.getElementById('newCategory').value;
  const status = document.getElementById('newStatus').value;
  const priority = document.getElementById('newPriority').value;
  const tags = document.getElementById('newTags').value;
  const notes = document.getElementById('newNotes').value;
  const fileInput = document.getElementById('newPhoto');
  let photo = '';
  if(fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    photo = await new Promise(resolve=>{
      const r = new FileReader(); r.onload = ()=> resolve(r.result); r.readAsDataURL(f);
    });
  }
  await addItem({id:uid(),name,category,status,priority,tags,notes,photo});
  // clear inputs
  document.getElementById('newName').value=''; document.getElementById('newTags').value=''; document.getElementById('newNotes').value=''; fileInput.value='';
});

document.getElementById('search').addEventListener('input', ()=> renderWardrobeList());
document.getElementById('filterStatus').addEventListener('change', ()=> renderWardrobeList());
document.getElementById('filterPriority').addEventListener('change', ()=> renderWardrobeList());

document.getElementById('addShopBtn').addEventListener('click', async ()=>{
  const item = (document.getElementById('shopName').value||'').trim(); if(!item) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏');
  const priority = document.getElementById('shopPriority').value; const price = document.getElementById('shopPrice').value;
  await addShopping({id:uid(),item,priority,price,category:'',plannedDate:'',purchased:false});
  document.getElementById('shopName').value=''; document.getElementById('shopPrice').value='';
});

document.getElementById('addOutfitBtn').addEventListener('click', async ()=>{
  const name = (document.getElementById('outfitName').value||'').trim(); if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞');
  const category = document.getElementById('outfitCategory').value; const season = document.getElementById('outfitSeason').value;
  const items = (document.getElementById('outfitItems').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(items.length===0) return alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≤–µ—â—å –≤ –æ–±—Ä–∞–∑');
  await addOutfit({id:uid(),name,category,season,items});
  document.getElementById('outfitName').value=''; document.getElementById('outfitItems').value=''; renderOutfits();
});

document.getElementById('outfitFilter').addEventListener('change', renderOutfits);

document.getElementById('addLinkBtn').addEventListener('click', async ()=>{
  const url = (document.getElementById('newLink').value||'').trim(); if(!url) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É');
  await addLink(url); document.getElementById('newLink').value=''; renderLinks();
});

document.getElementById('exportWardrobeBtn').addEventListener('click', async ()=>{
  const w = await storageGet(STORAGE_KEYS.wardrobe) || {};
  let txt = Object.entries(w).map(([cat,items]) => `\n=== ${cat.toUpperCase()} ===\n` + items.map(i=> `${i.name} - ${i.status} - ${i.priority} - ${i.tags||''}`).join('\n')).join('\n');
  const blob = new Blob([txt],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='wardrobe.txt'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('exportShoppingBtn').addEventListener('click', async ()=>{
  const s = await storageGet(STORAGE_KEYS.shopping) || []; const text = s.map(i=> `${i.item} - ${i.priority} - ${i.price} - ${i.category} ${i.purchased? '(–∫—É–ø–ª–µ–Ω–æ '+(i.purchasedDate||'')+')':''}`).join('\n');
  const blob = new Blob([text],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='shopping-list.txt'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('clearAllBtn').addEventListener('click', async ()=>{
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–µ—â–∏ –∏ –ø–æ–∫—É–ø–∫–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.')) return;
  localStorage.removeItem(STORAGE_KEYS.wardrobe); localStorage.removeItem(STORAGE_KEYS.shopping); localStorage.removeItem(STORAGE_KEYS.outfits); localStorage.removeItem(STORAGE_KEYS.links); localStorage.removeItem(STORAGE_KEYS.analytics);
  await storageInit(); renderAll();
});

document.getElementById('toggleView').addEventListener('click', ()=>{
  // open analytics tab
  document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
  document.querySelector('.tab[data-tab="analytics"]').classList.add('active');
  showTab('analytics');
});

document.getElementById('downloadReport').addEventListener('click', exportFullReport);
document.getElementById('closeAnalytics').addEventListener('click', ()=>{
  document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active'));
  document.querySelector('.tab[data-tab="wardrobe"]').classList.add('active');
  showTab('wardrobe');
});

// tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=> { document.querySelectorAll('.tab').forEach(t=> t.classList.remove('active')); btn.classList.add('active'); showTab(btn.dataset.tab); });
});
function showTab(name){
  ['wardrobe','shopping','outfits','inspiration','analytics'].forEach(id=> document.getElementById(id).style.display = id===name? 'block':'none');
}

// analytics events list accessible via storage key

// initialize & render
(async function init(){
  await storageInit();
  renderAll();
})();
</script>
</body>
</html>
